
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KI-Reifegrad Service (Maschinenbau) – Fragebogen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand: #C9133B; /* Primärfarbe Rot */
      --brand-dark: #9F1239; /* Hover/Darker Rot */
      --brand-contrast: #ffffff;
    }
    body { font-family: 'Inter', sans-serif; }
    /* Gartner scale bar */
    .scale-container { position: relative; height: 1.5rem; display: flex; align-items: center; border-radius:9999px; overflow:hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); }
    .scale-segment { height:100%; flex-grow:1; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:0.75rem; line-height:1rem; text-shadow:1px 1px 2px rgba(0,0,0,0.2); }
    .indicator { position:absolute; width:1rem; height:1rem; background:#fff; border-radius:9999px; box-shadow:0 2px 4px rgba(0,0,0,0.2); transform:translateX(-50%); transition:left .5s ease-in-out; border:2px solid; z-index:10; }
    /* Gauge bars for per-dimension scores */
    .gauge-bar-container { width:100%; height:0.75rem; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
    .gauge-bar { height:100%; border-radius:9999px; transition: width .5s ease-in-out, background-color .5s ease-in-out; background-color:#ef4444; }
    /* Radio pill styles */
    .pill-group { display:flex; flex-direction:column; gap:1.25rem; }
    .pill { display:flex; align-items:flex-start; gap:1rem; padding:.85rem 1.2rem; border:1px solid #e5e7eb; border-radius:.9rem; background:#fff; transition: border-color .2s, box-shadow .2s; }
    .pill:hover { border-color:#cbd5e1; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .pill input[type="radio"] { margin-top:.2rem; }
    /* Segmented control radios for 1–5 Likert (no longer used) */
    .segmented { display:none; }
    .segment { display:none; }
    /* Cards */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:0.9rem; padding:1.6rem; }
    /* Brand button */
    .btn-brand { background: var(--brand); color: var(--brand-contrast); }
    .btn-brand:hover { background: var(--brand-dark); }
    /* Brand focus */
    input:focus, button:focus { outline: none; box-shadow: 0 0 0 2px var(--brand); }
    /* Slider (Likert) in Grautönen */
    .likert-slider { -webkit-appearance: none; width: 100%; height: 0.5rem; background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 50%, #9ca3af 100%); border-radius: 9999px; outline: none; }
    .likert-slider::-webkit-slider-runnable-track { height: 0.5rem; background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 50%, #9ca3af 100%); border-radius: 9999px; }
    .likert-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1rem; height: 1rem; border-radius: 9999px; background: #9ca3af; border: 2px solid #6b7280; cursor: pointer; margin-top: -0.25rem; }
    .likert-slider::-moz-range-thumb { width: 1rem; height: 1rem; border-radius: 9999px; background: #9ca3af; border: 2px solid #6b7280; cursor: pointer; }
    .likert-slider::-moz-range-track { height: 0.5rem; background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 50%, #9ca3af 100%); border-radius: 9999px; }
    .likert-slider:focus { box-shadow: 0 0 0 2px rgba(107,114,128,0.25); }
    /* Progress */
    .progress-wrap { margin-top:.5rem; }
    .progress-track { width:100%; height:0.5rem; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
    .progress-bar { height:100%; width:0%; background:#6b7280; transition: width .3s ease; }
    /* Accordion */
    .accordion-title { display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .accordion-title .chev { transition: transform .2s ease; }
    .accordion-title[aria-expanded="true"] .chev { transform: rotate(90deg); }
    .accordion-content { margin-top:1rem; }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
  <div id="app" class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg px-8 sm:px-12 pt-14 sm:pt-24 pb-8 sm:pb-12 relative">
    <img alt="V&S Logo" src="https://v-und-s.de/wp-content/uploads/2021/11/VS_25_Jahre_Logo_RGB_RZ-300x198.png" class="hidden sm:block absolute top-6 right-6 h-20 md:h-24"/>
    <div class="text-center mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">KI-Reifegrad – Service im Maschinenbau</h1>
      <p class="text-gray-600 text-sm sm:text-base">Am Ende erhalten Sie Ihren KI-Reifegrad als Gesamtscore und für die Dimensionen Strategie, Organisation, Regulatorik, Technologie, Aktuelle Operationalisierung und Rahmenbedingungen sowie eine aussagekräftige Spidergrafik der Dimensionen zur Einschätzung Ihres aktuellen KI-Reifegrads.</p>
    </div>

    <div class="mb-10 p-6 bg-gray-50 rounded-lg">
      <div class="flex items-center mb-3 gap-2">
        <label for="name" class="font-medium text-gray-700 whitespace-nowrap">Name:</label>
        <input id="name" type="text" placeholder="Vor- und Nachname" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
      <div class="flex items-center mb-3 gap-2">
        <label for="firma" class="font-medium text-gray-700 whitespace-nowrap">Firma:</label>
        <input id="firma" type="text" required placeholder="Name der Firma" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
      <div class="progress-wrap">
        <div class="flex justify-between text-xs text-gray-500 mb-1"><span>Fortschritt</span><span id="progress-text">0/0</span></div>
        <div class="progress-track"><div id="progress-bar" class="progress-bar"></div></div>
      </div>
    </div>

    <!-- MCQ Dimensions -->
    <div id="mcq-section" class="space-y-12"></div>

    <!-- Likert Groups -->
    <div id="likert-section" class="space-y-12 mt-12"></div>

    <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-4">
      <button id="calc-btn" disabled class="w-full sm:w-auto px-8 py-3 btn-brand font-bold rounded-full shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Scores berechnen</button>
      <button id="reset-btn" class="w-full sm:w-auto px-8 py-3 border border-gray-300 text-gray-700 font-bold rounded-full hover:bg-gray-50 transition">Zurücksetzen</button>
    </div>
    <div id="calc-hint" class="mt-3 text-sm text-red-600 text-center hidden"></div>

    <!-- Results -->
    <div id="results" class="mt-10 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Ihre Scores</h2>
      <p class="text-sm text-gray-500 mb-3">Die Ergebnisse geben Ihnen einen ersten Eindruck Ihres KI-Reifegrads. Eine vollständige Bewertung umfasst jedoch weitere qualitative Aspekte – sprechen Sie uns gern für eine vertiefte Analyse an.</p>
      <p class="text-sm text-gray-600 mb-6">Ihr KI-Reifegrad auf einen Blick – als Gesamtscore, in allen Dimensionen und als Spidergrafik. Für ein unverbindliches, kostenfreies Auswertungsgespräch: <a class="text-red-600 font-medium" href="mailto:meyer@v-und-s.de">meyer@v-und-s.de</a></p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="scores-grid"></div>

      <div class="mt-6 pt-4 border-t border-indigo-200">
        <div class="flex justify-between items-center text-lg font-bold text-gray-900">
          <span>Gesamtscore:</span>
          <span id="total-score" class="text-2xl font-extrabold text-gray-900">0.0%</span>
        </div>

        <!-- Maturity scale -->
        <div class="mt-4">
          <p class="text-sm text-center text-gray-600 mb-2">Ihr KI-Reifegrad</p>
          <div class="scale-container">
            <div class="scale-segment bg-red-500">Awareness</div>
            <div class="scale-segment bg-orange-500">Active</div>
            <div class="scale-segment bg-green-500">Operational</div>
            <div class="scale-segment bg-blue-500">Systemic</div>
            <div class="scale-segment bg-purple-500">Transformational</div>
            <div id="indicator" class="indicator border-red-500" style="left:0%;"></div>
          </div>
          <p id="maturity-text" class="text-center mt-2 font-semibold text-gray-800 text-base">Level 1: Awareness</p>
        </div>

        <div class="mt-8">
          <h3 class="text-xl font-semibold text-gray-900 text-center mb-4">Reifegrad pro Dimension</h3>
          <canvas id="radar" height="320"></canvas>
        </div>

        <div class="mt-6 flex justify-center">
          <button id="download-btn" disabled class="px-6 py-3 btn-brand font-bold rounded-full shadow transition disabled:opacity-50 disabled:cursor-not-allowed">Auswertung herunterladen</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-8 leading-relaxed">Die Analyse zeigt Ihnen, wo Sie heute stehen. Im Gespräch erfahren Sie, wie andere Unternehmen ihren Weg weitergegangen sind – und welche Optionen es für Sie gibt. Bei Interesse: <a class="text-red-600 font-medium" href="mailto:meyer@v-und-s.de">meyer@v-und-s.de</a></p>
    </div>
  </div>

<script>
// ---------- Data ----------

// MCQ (Stufe 1–5) pro Dimension – exakt eine Antwort pro Dimension
const MCQ_DIMENSIONS = [
  // Strategie (1–4)
  {
    key: "Ambition",
    group: "Strategie",
    subtitle: "Zielbild und Rolle von KI im Service",
    options: [
      "Unsere Service-Abteilung ist sich der Relevanz von KI unsicher und weiß nicht, welche Rolle KI im Service spielen soll.",
      "Unsere Service-Abteilung ist sich der Relevanz von KI bewusst, ist aber unsicher, welche Rolle KI im Service spielen soll.",
      "Unsere Service-Abteilung versteht die Auswirkungen von KI und hat ein Zielbild entwickelt, an dem wir unsere KI-Aktivitäten ausrichten wollen.",
      "Es gibt ein klares Verständnis dafür, wie unsere Service-Abteilung sich an KI-getriebene Veränderungen anpassen kann. Eine Roadmap berücksichtigt ethische und rechtliche Aspekte.",
      "KI und ihr Potenzial werden bereits im Tagesgeschäft berücksichtigt (z. B. Wartung, Ersatzteilmanagement, Kundenkommunikation)."
    ]
  },
  {
    key: "Strategie",
    group: "Strategie",
    subtitle: "Abgestimmte KI-Strategie und KPIs",
    options: [
      "Entscheidungen zum Einsatz von KI im Service werden ad hoc getroffen und folgen keinem systematischen Ansatz.",
      "Unsere Service-Abteilung verfügt über eine abgestimmte KI-Strategie mit konkreten Initiativen.",
      "Die KI-Strategie prägt Serviceprozesse und digitale Dienstleistungen; Erfolgsmessung über definierte KPIs.",
      "KI steht im Zentrum unseres Service-Modells (z. B. Predictive Maintenance, digitale Portale)."
    ]
  },
  {
    key: "Use Cases",
    group: "Strategie",
    subtitle: "Systematische Identifikation und Umsetzung von Use Cases",
    options: [
      "Wir haben bisher keine KI-Use-Cases identifiziert/umgesetzt.",
      "Use-Cases entstehen opportunistisch, ohne feste Kriterien.",
      "Wir haben einen Standardprozess: systematisches Finden, Bewerten und Priorisieren.",
      "KI Use Cases werden bereits ganzheitlich entlang der Service-Wertschöpfungskette umgesetzt."
    ]
  },
  {
    key: "Umsetzung",
    group: "Strategie",
    subtitle: "Wertrealisierung & Business-Case",
    options: [
      "Kein Business-Case; Nutzen wird nicht gemessen.",
      "Erste Annahmen/Schätzungen zu Nutzen/ROI vorhanden.",
      "Standardisierte Business-Cases; Benefits werden gemessen und berichtet.",
      "Kontinuierliches Benefits-Tracking steuert Priorisierung/Roadmap."
    ]
  },
  // Organisation (5–8)
  {
    key: "Organisation",
    group: "Organisation",
    subtitle: "Strukturen, Verantwortlichkeiten und Zusammenarbeit",
    options: [
      "Es gibt keine Verantworlichkeiten oder Strukturen für KI im Service.",
      "Einzelpersonen treiben Themen in Silos voran.",
      "Klare Verantwortlichkeiten; zentrales Enablement-Team unterstützt.",
      "IT, Service & Data arbeiten eingespielt; Standards/Best Practices verankert."
    ]
  },
  {
    key: "Expertise",
    group: "Organisation",
    subtitle: "Fähigkeiten und Rollen im Service",
    options: [
      "Uns fehlen die notwendigen Fähigkeiten und Personen, um KI-Projekte umzusetzen.",
      "Das nötige Fachwissen ist in unserer IT Abteilung verankert und wird für KI-Projekte rangezogen.",
      "Das nötige Fachwissen und relevante Kernrollen sind im Service-Team vorhanden (z. B. KI-Manager, KI-Spezialist, Data Analysts, Service Engineers).",
      "Wir gelten als Vorreiter für KI im Service; Mitarbeitende arbeiten mit modernster Technologie und präsentieren Ergebnisse extern."
    ]
  },
  {
    key: "Kultur",
    group: "Organisation",
    subtitle: "Mindset, Datenorientierung und Vertrauen",
    options: [
      "Wir haben noch nicht darüber nachgedacht, welches Umfeld für erfolgreiche KI-Projekte im Service erforderlich ist.",
      "Wir verstehen die Bedeutung von KI-Experimenten und interdisziplinärer Zusammenarbeit (Service, IT, Konstruktion).",
      "Wir sehen uns als datengetrieben; Führungskräfte gehen voran und begleiten die Einführung aktiv.",
      "Das Vertrauen in KI ist verbreitet; Mitarbeitende verstehen probabilistische Systeme und können damit arbeiten."
    ]
  },
  {
    key: "Adoption",
    group: "Organisation",
    subtitle: "Change- & Adoption-Ansatz",
    options: [
      "Keine strukturierte Adoption vorgesehen.",
      "Schulungen finden anlassbezogen statt.",
      "Rollenbasierte Enablement-Journeys; Champions; Human-in-the-Loop.",
      "Messbare Adoption (Nutzung/Qualität); Feedback fließt in Backlog."
    ]
  },
  // Regulatorik (9–10)
  {
    key: "Governance",
    group: "Regulatorik",
    subtitle: "Verantwortlichkeiten & Governance",
    options: [
      "Es gibt keine klaren Verantwortlichkeiten für regulatorische KI-Anforderungen.",
      "Verantwortlichkeiten für regulatorische KI-Themen sind einzelnen Personen nebenbei zugeordnet.",
      "Ein dediziertes Team oder KI-Beauftragte koordinieren regulatorische Anforderungen; Prozesse existieren, sind aber noch punktuell.",
      "Ein institutionalisiertes KI-Compliance-Team steuert Governance, Reviews und Reporting mit klar definierten Entscheidungswegen."
    ]
  },
  {
    key: "Dokumentation",
    group: "Regulatorik",
    subtitle: "Dokumentation & Nachvollziehbarkeit",
    options: [
      "KI-Entscheidungen werden nicht systematisch dokumentiert.",
      "Dokumentation erfolgt fallweise, ohne Standardisierung.",
      "Standardisierte Templates/Prozesse zur Dokumentation (z. B. Modellbeschreibungen, Verantwortliche) sind etabliert.",
      "Dokumentation ist automatisiert, auditierbar und umfasst Modellkarten, Risiko-Logs und freigegebene Leitlinien."
    ]
  },
  // Technologie (11–12)
  {
    key: "Technologie",
    group: "Technologie",
    subtitle: "Tools, Infrastruktur und Skalierbarkeit",
    options: [
      "Unklar, ob geeignete Tools/Infrastruktur verfügbar sind.",
      "Service-Teams haben Zugang zu erforderlichen Tools/Infrastruktur.",
      "Standardisierung/Zentralisierung mit klaren Leitplanken (Modelle/Plattformen).",
      "Reibungslose Bereitstellung & Skalierung; Integration in Workflows."
    ]
  },
  {
    key: "Daten",
    group: "Technologie",
    subtitle: "Verfügbarkeit, Qualität und Governance",
    options: [
      "Für KI-Projekte im Service fehlen häufig die nötigen Daten oder sie sind von geringer Qualität.",
      "Relevante Datenquellen werden identifiziert; Daten-Pipelines sind etabliert.",
      "Erste Prozesse für Datenqualität, Datenklassifizierungen, Zuständigkeiten und Zugänglichkeit; sowie zentrale Ablagen sind vorhanden.",
      "Zentrales Datensystem ermöglicht Suche/Zugang; Mechanismen zur Wahrung der Datenqualität sind etabliert. Daten sind kategorisiert und versioniert."
    ]
  }
];

// Likert (1–5) – Ja/Nein 5-stufig
const LIKERT_GROUPS = [
  {
    key: "Aktuelle Operationalisierung",
    items: [
      "Setzen Sie KI ein, um Kaufverhalten und Präferenzen Ihrer Kunden vorherzusagen?",
      "Gibt es KI-gestützte Systeme, die Servicekapazitäten unterstützen (z. B. KI-Assistenten, Chatbots)?",
      "Unterstützt KI die Priorisierung &/oder Sortierung von Servicefällen (z. B. Ticket-Klassifizierung)?",
      "Unterstützt KI die Einsatzplanung durch automatische Tourenoptimierung und Kapazitätsprognosen?",
      "Werden Skills und Verfügbarkeiten von Servicemitarbeitenden durch KI gematcht und dynamisch angepasst?",
      "Nutzt Ihr Unternehmen KI, um „Könner“-Wissen verfügbar zu machen?",
      "Nutzen Sie KI für Anfragen- und Angebotsautomatisierung?",
      "Unterstützt KI bei kreativen Tätigkeiten (z. B. Content-Generierung)?",
      "Nutzt Ihr Unternehmen KI, um digitale Serviceprodukte (z. B. KI-gestützte Wartungsservices) zu entwickeln?"
    ]
  },
  {
    key: "Regulatorik",
    items: [
      "Fühlt sich Ihr Unternehmen gut auf zukünftige gesetzliche Anforderungen (z. B. EU AI Act) vorbereitet?",
      "Haben Sie klare Richtlinien oder Leitlinien für den Einsatz von KI?",
      "Bewertet Ihr Unternehmen systematisch Risiken von KI-Anwendungen (z. B. Bias, Fehlentscheidungen, Sicherheit)?"
    ]
  },
  {
    key: "Rahmenbedingungen",
    items: [
      "Beinhaltet Ihre Service-/Unternehmensstrategie klare Ziele zur Nutzung von KI?",
      "Ist Ihr Unternehmen generell schnell darin, neue Technologien und digitale Innovationen zu übernehmen?",
      "Beobachten Sie aktiv Markttrends und die Konkurrenz in Bezug auf KI-Einsatz?",
      "Verfügen Ihre Mitarbeiter über die nötigen Fähigkeiten, um KI-Technologien einzuführen und zu nutzen?",
      "Bieten Sie Schulungen an, um Kompetenzen im Bereich KI/Datenanalyse aufzubauen?",
      "Ist Ihre IT-Infrastruktur (z. B. Rechenleistung, Cloud-Anbindung) für den Einsatz von KI ausgelegt?",
      "Haben Sie eine Strategie zur Datenverwaltung, die auch die Nutzung für KI berücksichtigt?",
      "Gibt es eine ausgeprägte Innovationskultur, die Experimente mit KI fördert?",
      "Verfolgen Sie aktiv Entwicklungen bei Partnern und Ökosystemen, um neue KI-Chancen zu erkennen?"
    ]
  }
];

const GROUP_DISPLAY_ORDER = [
  { key: "Strategie", label: "Strategie" },
  { key: "Organisation", label: "Organisation" },
  { key: "Regulatorik", label: "Regulatorik" },
  { key: "Technologie", label: "Technologie" },
  { key: "Aktuelle Operationalisierung", label: "Aktuelle Operationalisierung" },
  { key: "Rahmenbedingungen", label: "Rahmenbedingungen" }
];

// ---------- Rendering ----------

function renderMcq() {
  const container = document.getElementById('mcq-section');
  container.innerHTML = "";

  // Group MCQ dimensions by their 'group' property
  const order = ["Strategie", "Organisation", "Regulatorik", "Technologie"];
  const grouped = new Map();
  MCQ_DIMENSIONS.forEach(d => {
    const g = d.group || 'Sonstiges';
    if (!grouped.has(g)) grouped.set(g, []);
    grouped.get(g).push(d);
  });

  // Ensure original order within groups
  let runningNumber = 1;
  order.forEach(groupName => {
    const dims = grouped.get(groupName);
    if (!dims || !dims.length) return;

    const card = document.createElement('div');
    card.className = "card";

    const title = document.createElement('h3');
    title.className = "text-lg font-semibold text-gray-800 mb-6 accordion-title";
    title.setAttribute('aria-expanded', 'true');
    title.innerHTML = `<span>Dimension: ${groupName}</span><span class=\"chev text-gray-400\">›</span>`;
    card.appendChild(title);

    const content = document.createElement('div');
    content.className = 'accordion-content';

    dims.forEach(dim => {
      const subTitle = document.createElement('h4');
      subTitle.className = "font-medium text-gray-700 mt-6 mb-4";
      subTitle.textContent = `${runningNumber}. ${dim.subtitle || dim.key}`;
      content.appendChild(subTitle);

      const group = document.createElement('div');
      group.className = "pill-group mb-8";

      dim.options.forEach((text, i) => {
        const id = `mcq-${dim.key}-${i+1}`;
        const label = document.createElement('label');
        label.className = "pill";

        const input = document.createElement('input');
        input.type = "radio";
        input.name = `mcq-${dim.key}`;
        input.value = (i+1).toString(); // 1..n
        input.id = id;

        const span = document.createElement('span');
        // Keine "Stufe X:"-Präfixe anzeigen
        span.textContent = text;

        label.appendChild(input);
        label.appendChild(span);
        group.appendChild(label);
      });

      content.appendChild(group);
      runningNumber++;
    });

    if (groupName === 'Regulatorik') {
      const regLikert = LIKERT_GROUPS.find(g => g.key === 'Regulatorik');
      if (regLikert) {
        regLikert.items.forEach((q, idx) => {
          const qDiv = document.createElement('div');
          qDiv.className = "mb-12";

          const p = document.createElement('p');
          p.className = "text-gray-800 mb-4 leading-relaxed";
          p.textContent = q;
          qDiv.appendChild(p);

          const row = document.createElement('div');
          row.className = "flex items-center gap-6";

          const leftLab = document.createElement('span');
          leftLab.className = "text-xs text-gray-500 whitespace-nowrap";
          leftLab.textContent = "Nein";
          row.appendChild(leftLab);

          const slider = document.createElement('input');
          slider.type = 'range';
          slider.min = '1';
          slider.max = '5';
          slider.step = '1';
          slider.value = '1';
          slider.name = `likert-${regLikert.key}-${idx}`;
          slider.className = 'likert-slider';
          row.appendChild(slider);

          const rightLab = document.createElement('span');
          rightLab.className = "text-xs text-gray-500 whitespace-nowrap";
          rightLab.textContent = "Ja";
          row.appendChild(rightLab);

          qDiv.appendChild(row);

          const helper = document.createElement('div');
          helper.className = 'text-xs text-gray-500 mt-1';
          const labels = ["Nein", "eher nein", "teilweise", "eher ja", "Ja"];
          const updateHelper = () => {
            const v = parseInt(slider.value, 10);
            helper.textContent = `${v} – ${labels[v-1]}`;
          };
          slider.addEventListener('input', updateHelper);
          updateHelper();
          qDiv.appendChild(helper);

          content.appendChild(qDiv);
        });

        runningNumber++;
      }
    }

    card.appendChild(content);
    title.addEventListener('click', () => {
      const expanded = title.getAttribute('aria-expanded') === 'true';
      title.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      content.style.display = expanded ? 'none' : '';
    });

    container.appendChild(card);
  });
}

function renderLikert() {
  const container = document.getElementById('likert-section');
  container.innerHTML = "";

  const filteredGroups = LIKERT_GROUPS.filter(grp => grp.key !== 'Regulatorik');

  filteredGroups.forEach((grp, gidx) => {
    const wrapper = document.createElement('div');
    wrapper.className = "card";

    const title = document.createElement('h3');
    title.className = "text-lg font-semibold text-gray-800 mb-6 accordion-title";
    title.setAttribute('aria-expanded', 'true');
    title.innerHTML = `<span>${MCQ_DIMENSIONS.length + gidx + 1}. ${grp.key}</span><span class=\"chev text-gray-400\">›</span>`;
    wrapper.appendChild(title);

    const content = document.createElement('div');
    content.className = 'accordion-content';

    grp.items.forEach((q, qidx) => {
      const qDiv = document.createElement('div');
      qDiv.className = "mb-12";

      const p = document.createElement('p');
      p.className = "text-gray-800 mb-4 leading-relaxed";
      p.textContent = q;
      qDiv.appendChild(p);

      // Slider row
      const row = document.createElement('div');
      row.className = "flex items-center gap-6";

      const leftLab = document.createElement('span');
      leftLab.className = "text-xs text-gray-500 whitespace-nowrap";
      leftLab.textContent = "Nein";
      row.appendChild(leftLab);

      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = '1';
      slider.max = '5';
      slider.step = '1';
      slider.value = '1';
      slider.name = `likert-${grp.key}-${qidx}`;
      slider.className = 'likert-slider';
      row.appendChild(slider);

      const rightLab = document.createElement('span');
      rightLab.className = "text-xs text-gray-500 whitespace-nowrap";
      rightLab.textContent = "Ja";
      row.appendChild(rightLab);

      qDiv.appendChild(row);

      const helper = document.createElement('div');
      helper.className = 'text-xs text-gray-500 mt-1';
      const labels = ["Nein", "eher nein", "teilweise", "eher ja", "Ja"];
      const updateHelper = () => {
        const v = parseInt(slider.value, 10);
        helper.textContent = `${v} – ${labels[v-1]}`;
      };
      slider.addEventListener('input', updateHelper);
      updateHelper();
      qDiv.appendChild(helper);

      content.appendChild(qDiv);
    });

    wrapper.appendChild(content);
    // Toggle
    title.addEventListener('click', () => {
      const expanded = title.getAttribute('aria-expanded') === 'true';
      title.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      content.style.display = expanded ? 'none' : '';
    });

    container.appendChild(wrapper);
  });
}

// ---------- Scoring ----------

function normalize(value, min, max) {
  if (value == null) return 0;
  return (value - min) / (max - min) * 100;
}

function gartnerFromPercent(p) {
  // 5-level mapping 0–100
  if (p <= 20) return {level:1, name:'Awareness', color:'border-red-500'};
  if (p <= 40) return {level:2, name:'Active', color:'border-orange-500'};
  if (p <= 60) return {level:3, name:'Operational', color:'border-green-500'};
  if (p <= 80) return {level:4, name:'Systemic', color:'border-blue-500'};
  return {level:5, name:'Transformational', color:'border-purple-500'};
}

function calculate() {
  const firmaVal = (document.getElementById('firma')?.value || '').trim();
  if (!firmaVal) { alert('Bitte geben Sie den Firmennamen an.'); document.getElementById('firma')?.focus(); return; }

  const dimPercents = {};
  const groupBuckets = new Map();
  let allAnswered = true;

  MCQ_DIMENSIONS.forEach(dim => {
    const selected = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
    if (!selected) { allAnswered = false; }
    const points = selected ? parseInt(selected.value, 10) : null; // 1..n
    const percent = points ? normalize(points, 1, dim.options.length) : 0; // 0..100
    dimPercents[dim.key] = percent;
    const bucketName = dim.group || dim.key;
    if (!groupBuckets.has(bucketName)) groupBuckets.set(bucketName, []);
    groupBuckets.get(bucketName).push(percent);
  });

  LIKERT_GROUPS.forEach(grp => {
    let sum = 0, cnt = 0;
    grp.items.forEach((q, idx) => {
      const sel = document.querySelector(`input[name="likert-${grp.key}-${idx}"]`);
      const val = sel ? parseInt(sel.value, 10) : null; // 1..5
      if (val != null && !Number.isNaN(val)) { sum += val; cnt++; } else { allAnswered = false; }
    });
    const avg = cnt ? (sum / cnt) : 0;
    const percent = cnt ? normalize(avg, 1, 5) : 0;
    dimPercents[grp.key] = percent;
    groupBuckets.set(grp.key, [percent]);
  });

  if (!allAnswered) {
    alert("Bitte beantworten Sie alle Fragen.");
    return;
  }

  const aggregatedPercents = {};
  groupBuckets.forEach((vals, name) => {
    const valid = vals.filter(v => !Number.isNaN(v));
    const avg = valid.length ? valid.reduce((a,b) => a + b, 0) / valid.length : 0;
    aggregatedPercents[name] = avg;
  });
  const aggregatedEntries = GROUP_DISPLAY_ORDER
    .map(({ key, label }) => ({ key, label, value: aggregatedPercents[key] }))
    .filter(entry => entry.value != null);

  const grid = document.getElementById('scores-grid');
  grid.innerHTML = "";
  const gaugeColor = (score) => {
    if (score <= 20) return '#ef4444';
    if (score <= 40) return '#f97316';
    if (score <= 60) return '#22c55e';
    if (score <= 80) return '#3b82f6';
    return '#7c3aed';
  };

  aggregatedEntries.forEach(({ label, value }) => {
    const card = document.createElement('div');
    card.className = "bg-white rounded-lg p-4 shadow-sm";

    const title = document.createElement('p');
    title.className = "font-medium text-gray-800 mb-2";
    title.textContent = label;
    card.appendChild(title);

    const barWrap = document.createElement('div');
    barWrap.className = "gauge-bar-container";
    const bar = document.createElement('div');
    bar.className = "gauge-bar";
    bar.style.width = value.toFixed(1) + '%';
    bar.style.backgroundColor = gaugeColor(value);
    barWrap.appendChild(bar);
    card.appendChild(barWrap);

    const val = document.createElement('p');
    val.className = "text-xl font-bold text-gray-900 mt-2";
    val.textContent = value.toFixed(1) + '%';
    card.appendChild(val);

    grid.appendChild(card);
  });

  const values = aggregatedEntries.map(entry => entry.value);
  const overall = values.length ? values.reduce((a,b) => a + b, 0) / values.length : 0;
  document.getElementById('total-score').textContent = overall.toFixed(1) + '%';

  const ind = document.getElementById('indicator');
  const maturityText = document.getElementById('maturity-text');
  ind.style.left = Math.max(0, Math.min(100, overall)) + '%';
  const g = gartnerFromPercent(overall);
  ind.className = 'indicator ' + g.color;
  maturityText.textContent = `Level ${g.level}: ${g.name}`;

  const ctx = document.getElementById('radar').getContext('2d');
  if (window._radar) { window._radar.destroy(); }
  const brandHex = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#6366f1';
  const hexToRgb = (hex) => {
    const h = hex.replace('#','');
    const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h, 16);
    const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return {r,g,b};
  };
  const rgb = hexToRgb(brandHex);
  const radarLabels = aggregatedEntries.map(entry => entry.label);
  const radarValues = aggregatedEntries.map(entry => entry.value);
  window._radar = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: radarLabels,
      datasets: [{
        label: 'Reifegrad (%)',
        data: radarValues,
        fill: true,
        backgroundColor: `rgba(${rgb.r},${rgb.g},${rgb.b},0.15)`,
        borderColor: `rgba(${rgb.r},${rgb.g},${rgb.b},1)`,
        pointBackgroundColor: `rgba(${rgb.r},${rgb.g},${rgb.b},1)`
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } }
      },
      plugins: { legend: { display: false } }
    }
  });

  document.getElementById('results').classList.remove('hidden');
  const dl = document.getElementById('download-btn');
  if (dl) dl.disabled = false;
  const hint = document.getElementById('calc-hint');
  if (hint) { hint.classList.add('hidden'); hint.textContent = ''; }
}

// ---------- Data Collection / Export ----------

function collectData(requireAll=true) {
  const name = (document.getElementById('name')?.value || '').trim();
  const firma = (document.getElementById('firma')?.value || '').trim();
  let allAnswered = true;

  const mcqAnswers = [];
  const dimPercents = {};
  const groupBuckets = new Map();

  MCQ_DIMENSIONS.forEach(dim => {
    const selected = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
    if (!selected) { allAnswered = false; }
    const points = selected ? parseInt(selected.value, 10) : null; // 1..n
    const percent = points ? normalize(points, 1, dim.options.length) : 0; // 0..100
    dimPercents[dim.key] = percent;
    const bucketName = dim.group || dim.key;
    if (!groupBuckets.has(bucketName)) groupBuckets.set(bucketName, []);
    groupBuckets.get(bucketName).push(percent);
    mcqAnswers.push({ dimension: dim.key, value: points, text: points ? dim.options[points-1] : null });
  });

  const likertLabels = ["Nein", "eher nein", "teilweise", "eher ja", "Ja"];
  const likertAnswers = [];

  LIKERT_GROUPS.forEach(grp => {
    let sum = 0, cnt = 0;
    const groupAnswers = [];
    grp.items.forEach((q, idx) => {
      const sel = document.querySelector(`input[name="likert-${grp.key}-${idx}"]`);
      const val = sel ? parseInt(sel.value, 10) : null; // 1..5
      if (val != null && !Number.isNaN(val)) { sum += val; cnt++; }
      else { allAnswered = false; }
      groupAnswers.push({ question: q, value: val, label: val ? likertLabels[val-1] : null });
    });
    const avg = cnt ? (sum / cnt) : 0;
    const percent = cnt ? normalize(avg, 1, 5) : 0;
    dimPercents[grp.key] = percent;
    groupBuckets.set(grp.key, [percent]);
    likertAnswers.push({ group: grp.key, answers: groupAnswers });
  });

  if (requireAll && !allAnswered) return null;

  const aggregatedPercents = {};
  groupBuckets.forEach((vals, name) => {
    const valid = vals.filter(v => !Number.isNaN(v));
    const avg = valid.length ? valid.reduce((a,b) => a + b, 0) / valid.length : 0;
    aggregatedPercents[name] = avg;
  });
  const aggregatedEntries = GROUP_DISPLAY_ORDER
    .map(({ key, label }) => ({ key, label, value: aggregatedPercents[key] }))
    .filter(entry => entry.value != null);
  const orderLabels = aggregatedEntries.map(entry => entry.label);
  const orderValues = aggregatedEntries.map(entry => entry.value);
  const overall = orderValues.length ? orderValues.reduce((a,b)=>a+b,0) / orderValues.length : 0;
  const g = gartnerFromPercent(overall);

  return {
    name,
    firma,
    allAnswered,
    orderLabels,
    orderValues,
    dimPercents,
    aggregatedPercents,
    overall,
    gartner: g,
    details: { mcq: mcqAnswers, likert: likertAnswers }
  };
}

// ---------- Events ----------

document.getElementById('calc-btn').addEventListener('click', calculate);
document.getElementById('reset-btn').addEventListener('click', () => {
  // reset all radios
  document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
  document.getElementById('results').classList.add('hidden');
  // remove active state from segmented
  document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
  // reset sliders to middle and update helper labels
  document.querySelectorAll('input.likert-slider').forEach(s => {
    s.value = '1';
    s.dispatchEvent(new Event('input'));
  });
  // clear firm name
  const firma = document.getElementById('firma');
  if (firma) firma.value = '';
  const name = document.getElementById('name');
  if (name) name.value = '';
  // disable buttons
  const dl = document.getElementById('download-btn');
  if (dl) dl.disabled = true;
  const calc = document.getElementById('calc-btn');
  if (calc) calc.disabled = true;
  // reset progress
  updateProgress();
});

// Download results as JSON
// Generate Excel (.xlsx) using SheetJS
function generateExcel(data) {
  const wb = XLSX.utils.book_new();
  const overview = [
    ["Name", data.name || ''],
    ["Firma", data.firma],
    ["Gesamtscore (%)", Number(data.overall.toFixed(1))],
    ["Reifegrad", `Level ${data.gartner.level} – ${data.gartner.name}`],
    ["Zeitstempel", new Date().toISOString()]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(overview), "Übersicht");

  const scoresRows = [["Dimension", "Score (%)"]];
  data.orderLabels.forEach((label, i) => {
    scoresRows.push([label, Number(data.orderValues[i].toFixed(1))]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(scoresRows), "Scores");

  const mcqRows = [["Dimension", "Wert (1–4)", "Antworttext"]];
  data.details.mcq.forEach(r => mcqRows.push([r.dimension, r.value ?? '', r.text ?? '']));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mcqRows), "MCQ-Antworten");

  const likertRows = [["Gruppe", "Frage", "Wert (1–5)", "Label"]];
  data.details.likert.forEach(g => {
    g.answers.forEach(a => likertRows.push([g.group, a.question, a.value ?? '', a.label ?? '']));
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(likertRows), "Likert-Antworten");

  const safeName = (data.firma || 'unternehmen').replace(/[^a-z0-9_-]+/gi,'_');
  XLSX.writeFile(wb, `auswertung_${safeName}_${Date.now()}.xlsx`);
}

// Generate PDF (Spiderchart + Scores list)
async function generatePdf(data) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) { alert('PDF-Bibliothek nicht geladen.'); return; }
  const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

  const marginX = 40;
  const pageWidth = doc.internal.pageSize.getWidth();
  const contentW = pageWidth - marginX * 2;
  const pageH = doc.internal.pageSize.getHeight();
  const bottomY = pageH - 40;
  const line = 14;
  const newPageIfNeeded = (y, extra = 0) => {
    if (y + extra > bottomY) { doc.addPage(); return 60; }
    return y;
  };

  const brandHex = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#C9133B';
  const hexToRgb = (hex) => {
    const h = hex.replace('#','');
    const bigint = parseInt(h.length === 3 ? h.split('').map(c => c + c).join('') : h, 16);
    return {
      r: (bigint >> 16) & 255,
      g: (bigint >> 8) & 255,
      b: bigint & 255
    };
  };
  const brandRgb = hexToRgb(brandHex);

  // preload logo (cache across calls)
  if (!window._vsLogoPromise) {
    const logoUrl = 'https://v-und-s.de/wp-content/uploads/2021/11/VS_25_Jahre_Logo_RGB_RZ-300x198.png';
    window._vsLogoPromise = fetch(logoUrl)
      .then(resp => resp.blob())
      .then(blob => new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(blob);
      }))
      .catch(() => null);
  }
  const logoDataUrl = await window._vsLogoPromise;

  // Header banner
  const headerHeight = 90;
  doc.setFillColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.rect(0, 0, pageWidth, headerHeight, 'F');
  doc.setFont('helvetica','bold');
  doc.setFontSize(20);
  doc.setTextColor(255, 255, 255);
  doc.text('KI-Reifegrad – Service im Maschinenbau', marginX, 42);
  doc.setFont('helvetica','normal');
  doc.setFontSize(11);
  let headerInfoY = 60;
  doc.text(`Firma: ${data.firma}`, marginX, headerInfoY);
  if (data.name) {
    headerInfoY += 14;
    doc.text(`Name: ${data.name}`, marginX, headerInfoY);
  }
  headerInfoY += 14;
  doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, marginX, headerInfoY);
  doc.textWithLink('meyer@v-und-s.de', pageWidth - marginX - 120, 60, { url: 'mailto:meyer@v-und-s.de' });

  if (logoDataUrl) {
    const logoWidth = 90;
    const logoHeight = logoWidth * (198 / 300);
    doc.addImage(logoDataUrl, 'PNG', pageWidth - marginX - logoWidth, 18, logoWidth, logoHeight);
  }

  doc.setTextColor(31, 41, 55);
  let currentY = headerHeight + 24;

  // Summary card
  const summaryHeight = 70;
  doc.setFillColor(248, 250, 252);
  doc.roundedRect(marginX, currentY, contentW, summaryHeight, 8, 8, 'F');
  doc.setDrawColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.roundedRect(marginX, currentY, contentW, summaryHeight, 8, 8, 'S');
  doc.setFontSize(12);
  doc.setTextColor(107, 114, 128);
  doc.text('Gesamtscore', marginX + 18, currentY + 24);
  doc.setFontSize(30);
  doc.setTextColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.text(`${data.overall.toFixed(1)}%`, marginX + 18, currentY + 52);
  doc.setFontSize(12);
  doc.setTextColor(31, 41, 55);
  doc.text(`Reifegrad: Level ${data.gartner.level} – ${data.gartner.name}`, marginX + 200, currentY + 32);
  doc.setFontSize(10);
  doc.setTextColor(107, 114, 128);
  doc.text('Kontakt:', marginX + contentW - 150, currentY + 24);
  doc.textWithLink('meyer@v-und-s.de', marginX + contentW - 90, currentY + 24, { url: 'mailto:meyer@v-und-s.de' });

  currentY += summaryHeight + 26;

  // Disclaimer
  doc.setFontSize(10);
  doc.setTextColor(55, 65, 81);
  const disclaimer = 'Die Ergebnisse geben Ihnen einen ersten Eindruck Ihres KI-Reifegrads. Eine vollständige Bewertung umfasst jedoch weitere qualitative Aspekte – sprechen Sie uns gern für eine vertiefte Analyse an und vereinbaren Sie jetzt Ihr unverbindliches und kostenfreies Erstgespräch. Im Gespräch erfahren Sie, wie andere Unternehmen ihren Weg weitergegangen sind – und welche Optionen es für Sie gibt. Bei Interesse:';
  const disclaimerLines = doc.splitTextToSize(disclaimer, contentW);
  disclaimerLines.forEach(line => {
    currentY = newPageIfNeeded(currentY, 14);
    doc.text(line, marginX, currentY);
    currentY += 12;
  });
  currentY = newPageIfNeeded(currentY, 14);
  doc.textWithLink('meyer@v-und-s.de', marginX, currentY, { url: 'mailto:meyer@v-und-s.de' });
  currentY += 22;

  // Dimension table
  doc.setFontSize(12);
  doc.setTextColor(31, 41, 55);
  doc.text('Scores je Dimension', marginX, currentY);
  currentY += 12;

  const tableGap = 12;
  const colWidth = (contentW - tableGap) / 2;
  const rowHeight = 42;
  const numRows = Math.ceil(data.orderLabels.length / 2);

  for (let row = 0; row < numRows; row++) {
    for (let col = 0; col < 2; col++) {
      const idx = row * 2 + col;
      if (idx >= data.orderLabels.length) break;
      const cellX = marginX + col * (colWidth + tableGap);
      const cellY = currentY + row * rowHeight;
      doc.setFillColor(252, 252, 252);
      doc.roundedRect(cellX, cellY, colWidth, rowHeight - 8, 6, 6, 'F');
      doc.setDrawColor(229, 231, 235);
      doc.roundedRect(cellX, cellY, colWidth, rowHeight - 8, 6, 6, 'S');
      doc.setFontSize(11);
      doc.setTextColor(107, 114, 128);
      doc.text(data.orderLabels[idx], cellX + 14, cellY + 18);
      doc.setFontSize(18);
      doc.setTextColor(brandRgb.r, brandRgb.g, brandRgb.b);
      doc.text(`${data.orderValues[idx].toFixed(1)}%`, cellX + 14, cellY + 36);
    }
  }

  currentY += numRows * rowHeight + 18;

  // Radar chart
  const canvas = document.getElementById('radar');
  if (canvas) {
    const chartHeight = 220;
    currentY = newPageIfNeeded(currentY, chartHeight + 30);
    doc.setFontSize(12);
    doc.setTextColor(31, 41, 55);
    doc.text('Radar-Darstellung', marginX, currentY);
    currentY += 10;
    const imgData = canvas.toDataURL('image/png', 1.0);
    const ratio = canvas.height ? (canvas.height / canvas.width) : (320 / 480);
    const imgW = Math.min(contentW, chartHeight / ratio);
    const imgH = imgW * ratio;
    const offsetX = marginX + (contentW - imgW) / 2;
    doc.addImage(imgData, 'PNG', offsetX, currentY, imgW, imgH);
    currentY += imgH + 24;
  }

  // Details section
  let y = newPageIfNeeded(currentY, 60);
  doc.setFontSize(13);
  doc.setTextColor(31, 41, 55);
  doc.text('Details – Antworten', marginX, y);
  y += 10;
  doc.setFontSize(12);
  y += 10;

  doc.text('MCQ (beschreibende Antworten):', marginX, y);
  y += 16;
  doc.setFontSize(11);
  data.details.mcq.forEach((row, idx) => {
    const val = row.value != null ? row.value : '-';
    const header = `${idx + 1}. ${row.dimension} – Wert: ${val}`;
    y = newPageIfNeeded(y, line * 2);
    doc.text(header, marginX, y);
    y += line;
    if (row.text) {
      const wrapped = doc.splitTextToSize(row.text, contentW);
      for (const w of wrapped) {
        y = newPageIfNeeded(y, line);
        doc.text(w, marginX, y);
        y += line;
      }
    } else {
      y += 2;
    }
    y += 6;
  });

  y = newPageIfNeeded(y, 30);
  doc.setFontSize(12);
  doc.setTextColor(31, 41, 55);
  doc.text('Likert (1–5, Nein–Ja):', marginX, y);
  y += 16;
  doc.setFontSize(11);
  data.details.likert.forEach(group => {
    y = newPageIfNeeded(y, line);
    doc.text(`Gruppe: ${group.group}`, marginX, y);
    y += line;
    group.answers.forEach((a, i) => {
      const val = a.value != null ? `${a.value} – ${a.label || ''}` : '-';
      const qPrefix = `${i + 1}) `;
      const wrappedQ = doc.splitTextToSize(qPrefix + a.question, contentW);
      wrappedQ.forEach(lineText => {
        y = newPageIfNeeded(y, line);
        doc.text(lineText, marginX, y);
        y += line;
      });
      y = newPageIfNeeded(y, line);
      doc.text(`Antwort: ${val}`, marginX, y);
      y += line + 4;
    });
    y += 6;
  });

  const safeName = (data.firma || 'unternehmen').replace(/[^a-z0-9_-]+/gi, '_');
  doc.save(`auswertung_${safeName}_${Date.now()}.pdf`);
}

document.getElementById('download-btn')?.addEventListener('click', async () => {
  const firmaVal = (document.getElementById('firma')?.value || '').trim();
  if (!firmaVal) { alert('Bitte geben Sie den Firmennamen an.'); document.getElementById('firma')?.focus(); return; }
  const data = collectData(true);
  if (!data) { alert('Bitte beantworten Sie alle Fragen, bevor Sie die Auswertung herunterladen.'); return; }
  try {
    generateExcel(data);
    await generatePdf(data);
  } catch (e) {
    console.error(e);
    alert('Beim Erstellen der Dateien ist ein Fehler aufgetreten.');
  }
});

// Init
renderMcq();
renderLikert();
// Bind progress and enable/disable logic
(function initUX(){
  function answeredMcqCount(){
    let cnt = 0;
    MCQ_DIMENSIONS.forEach(dim => {
      const sel = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
      if (sel) cnt++;
    });
    return cnt;
  }
  window.updateProgress = function(){
    const total = MCQ_DIMENSIONS.length;
    const ans = answeredMcqCount();
    const pct = total ? Math.round(ans/total*100) : 0;
    const bar = document.getElementById('progress-bar');
    const txt = document.getElementById('progress-text');
    if (bar) bar.style.width = pct + '%';
    if (txt) txt.textContent = `${ans}/${total}`;
    const calc = document.getElementById('calc-btn');
    const firma = (document.getElementById('firma')?.value || '').trim();
    const ready = ans === total && !!firma;
    if (calc) calc.disabled = !ready;

    // Build hint message if not ready
    const hint = document.getElementById('calc-hint');
    if (hint) {
      if (ready) {
        hint.classList.add('hidden');
        hint.textContent = '';
      } else {
        const missing = [];
        if (!firma) missing.push('Firmenname');
        MCQ_DIMENSIONS.forEach(dim => {
          const sel = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
          if (!sel) missing.push(dim.subtitle || dim.key);
        });
        hint.textContent = 'Bitte fehlende Angaben ergänzen: ' + missing.join(', ');
        hint.classList.remove('hidden');
      }
    }
  };
  // MCQ changes
  document.querySelectorAll('input[type="radio"]').forEach(r => r.addEventListener('change', updateProgress));
  // Firma changes
  const firmaEl = document.getElementById('firma');
  if (firmaEl) firmaEl.addEventListener('input', updateProgress);
  // Init
  updateProgress();
})();
</script>
</body>
</html>
