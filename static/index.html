<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KI-Reifegrad Service (Maschinenbau) ‚Äì Fragebogen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <style>
    :root {
      --brand: #C9133B; /* Prim√§rfarbe Rot */
      --brand-dark: #9F1239; /* Hover/Darker Rot */
      --brand-contrast: #ffffff;
    }
    body { font-family: 'Inter', sans-serif; }
    /* Gartner scale bar */
    .scale-container { position: relative; height: 1.5rem; display: flex; align-items: center; border-radius:9999px; overflow:hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); }
    .scale-segment { height:100%; flex-grow:1; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:0.75rem; line-height:1rem; text-shadow:1px 1px 2px rgba(0,0,0,0.2); }
    .indicator { position:absolute; width:1rem; height:1rem; background:#fff; border-radius:9999px; box-shadow:0 2px 4px rgba(0,0,0,0.2); transform:translateX(-50%); transition:left .5s ease-in-out; border:2px solid; z-index:10; }
    /* Gauge bars for per-dimension scores */
    .gauge-bar-container { width:100%; height:0.75rem; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
    .gauge-bar { height:100%; border-radius:9999px; transition: width .5s ease-in-out, background-color .5s ease-in-out; background-color:#ef4444; }
    /* Radio pill styles - elegant and puristic */
    .pill-group { display:flex; flex-direction:column; gap:0.75rem; }
    .pill {
      display:flex;
      align-items:flex-start;
      gap:0.75rem;
      padding:1rem;
      border:1px solid #e5e7eb;
      border-radius:0.5rem;
      background:#fafafa;
      cursor: pointer;
      transition: all .15s ease;
      position: relative;
    }
    .pill:hover {
      border-color:#d1d5db;
      background:#f9f9f9;
    }
    .pill input[type="radio"] {
      width: 1rem;
      height: 1rem;
      margin: 0;
      margin-top: 0.125rem;
      cursor: pointer;
      accent-color: #6b7280;
    }
    .pill input[type="radio"]:checked + span {
      font-weight: 500;
      color: #374151;
    }
    .pill:has(input[type="radio"]:checked) {
      border-color: #9ca3af;
      background: #f3f4f6;
    }
    /* Segmented control radios for 1‚Äì5 Likert (no longer used) */
    .segmented { display:none; }
    .segment { display:none; }
    /* Cards */
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:0.9rem; padding:1.6rem; }
    /* Elegant button */
    .btn-brand {
      background: var(--brand);
      color: white;
      transition: all .15s ease;
    }
    .btn-brand:hover {
      background: var(--brand-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(201, 19, 59, 0.15);
    }
    .btn-brand:disabled {
      background: #d1d5db;
      color: #9ca3af;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: #374151;
      color: white;
      transition: all .15s ease;
    }
    .btn-secondary:hover {
      background: #4b5563;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(55, 65, 81, 0.15);
    }
    .btn-secondary:disabled {
      background: #d1d5db;
      color: #9ca3af;
      transform: none;
      box-shadow: none;
    }
    /* Elegant focus */
    input:focus, button:focus { outline: none; box-shadow: 0 0 0 2px #9ca3af; }
    /* Likert grid layout - 2 boxes per row */
    .likert-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }
    @media (max-width: 768px) {
      .likert-grid {
        grid-template-columns: 1fr;
      }
    }
    .likert-question-box {
      background: #fafafa;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      transition: all 0.15s ease;
      display: flex;
      flex-direction: column;
      min-height: 150px;
    }
    .likert-question-box:hover {
      border-color: #d1d5db;
      background: #f9f9f9;
    }
    .likert-question-text {
      font-size: 1rem;
      color: #374151;
      line-height: 1.5;
      font-weight: 400;
      flex: 1;
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .likert-slider-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .likert-slider {
      -webkit-appearance: none;
      flex: 1;
      height: 0.5rem;
      background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 50%, #9ca3af 100%);
      border-radius: 9999px;
      outline: none;
      cursor: pointer;
    }
    /* Untouched state - light grey thumb */
    .likert-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 9999px;
      background: #e5e7eb;
      border: 2px solid #d1d5db;
      cursor: pointer;
      margin-top: -0.625rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .likert-slider::-moz-range-thumb {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 9999px;
      background: #e5e7eb;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 0 0 2px #d1d5db, 0 2px 4px rgba(0,0,0,0.1);
      margin-top: -0.625rem;
    }
    .likert-slider::-moz-range-track {
      height: 0.5rem;
      background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 50%, #9ca3af 100%);
      border-radius: 9999px;
    }
    /* Touched state - darker grey thumb */
    .likert-slider.touched::-webkit-slider-thumb {
      background: #9ca3af;
      border: 2px solid #6b7280;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transform: scale(1.05);
    }
    .likert-slider.touched::-moz-range-thumb {
      background: #9ca3af;
      box-shadow: 0 0 0 2px #6b7280, 0 2px 6px rgba(0,0,0,0.15);
      transform: scale(1.05);
    }
    .likert-slider:focus {
      box-shadow: 0 0 0 2px rgba(107,114,128,0.25);
    }
    .likert-label {
      font-size: 0.875rem;
      color: #6b7280;
      white-space: nowrap;
    }
    .likert-value {
      font-size: 0.875rem;
      color: #374151;
      font-weight: 500;
      margin-top: 0.5rem;
      text-align: center;
    }
    /* Progress */
    .progress-wrap { margin-top:.5rem; }
    .progress-track { width:100%; height:0.5rem; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
    .progress-bar { height:100%; width:0%; background:#9ca3af; transition: width .3s ease; }
    /* Accordion */
    .accordion-title { display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .accordion-title .chev { transition: transform .2s ease; }
    .accordion-title[aria-expanded="true"] .chev { transform: rotate(90deg); }
    .accordion-content { margin-top:1rem; }
    /* Message box styles */
    .message-box { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .message-box.show { display: flex; }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
  <div id="app" class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg px-8 sm:px-12 pt-14 sm:pt-24 pb-8 sm:pb-12 relative">
    <img alt="V&S Logo" src="https://v-und-s.de/wp-content/uploads/2021/11/VS_25_Jahre_Logo_RGB_RZ-300x198.png" class="absolute top-3 right-3 h-12 sm:top-6 sm:right-6 sm:h-20 md:h-24"/>
    <div class="text-center mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">KI-Reifegrad ‚Äì Service Excellence</h1>
      <p class="text-gray-600 text-sm sm:text-base"><b>360¬∞ Grad KI-Integration - Von Strategie bis Technologie</b> <br>
Erkennen Sie Ihre St√§rken und Potenziale im KI-Reifegrad ‚Äì √ºbersichtlich dargestellt als Chart.</p>
    </div>

    <!-- Debug banner when in debug mode -->
    <div id="debug-banner" style="display:none; background:#fef3c7; border:2px solid #f59e0b; padding:12px; margin:20px; border-radius:8px; text-align:center;">
      <strong>‚ö†Ô∏è DEBUG MODE ACTIVE</strong> - PDF generation without complete data is enabled
    </div>

    <!-- Sticky Progress Bar -->
    <div class="sticky top-0 z-50 bg-white border-b border-gray-200 p-4 mb-6">
      <div class="max-w-5xl mx-auto">
        <div class="progress-wrap">
          <div class="flex justify-between text-sm font-medium text-gray-700 mb-2"><span>Fortschritt</span><span id="progress-text">0/0</span></div>
          <div class="progress-track"><div id="progress-bar" class="progress-bar"></div></div>
        </div>
      </div>
    </div>

    <div class="mb-10 p-6 bg-gray-50 rounded-lg">
      <div class="flex items-center mb-3 gap-2">
        <label for="name" class="font-medium text-gray-700 whitespace-nowrap">Name:</label>
        <input id="name" type="text" placeholder="Vor- und Nachname" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
      <div class="flex items-center mb-3 gap-2">
        <label for="firma" class="font-medium text-gray-700 whitespace-nowrap">Firma:</label>
        <input id="firma" type="text" required placeholder="Name der Firma" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
    </div>

    <!-- MCQ Dimensions -->
    <div id="mcq-section" class="space-y-12"></div>

    <!-- Likert Groups -->
    <div id="likert-section" class="space-y-12 mt-12"></div>

    <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-4">
      <button id="calc-btn" disabled class="w-full sm:w-auto px-8 py-3 btn-brand font-bold rounded-full shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Auswertung erstellen</button>
      <button id="reset-btn" class="w-full sm:w-auto px-8 py-3 border border-gray-300 text-gray-700 font-bold rounded-full hover:bg-gray-50 transition">Zur√ºcksetzen</button>
    </div>
    <div id="calc-hint" class="mt-3 text-sm text-red-600 text-center hidden"></div>

    <!-- Results -->
    <div id="results" class="mt-10 hidden">
      <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-2">Ihre Scores</h2>
      <p class="text-sm text-gray-500 mb-3">Die Ergebnisse geben Ihnen einen ersten Eindruck Ihres KI-Reifegrads. Eine vollst√§ndige Bewertung umfasst jedoch weitere qualitative Aspekte ‚Äì sprechen Sie uns gern f√ºr eine vertiefte Analyse an.</p>
      <p class="text-sm text-gray-600 mb-6">Ihr KI-Reifegrad auf einen Blick ‚Äì als Gesamtscore, in allen Dimensionen und als Spidergrafik. F√ºr ein unverbindliches, kostenfreies Auswertungsgespr√§ch: <a class="text-red-600 font-medium" href="mailto:meyer@v-und-s.de">meyer@v-und-s.de</a></p>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="scores-grid"></div>

      <div class="mt-6 pt-4 border-t border-indigo-200">
        <div class="flex justify-between items-center text-lg font-bold text-gray-900">
          <span>Gesamtscore:</span>
          <span id="total-score" class="text-2xl font-extrabold text-gray-900">0.0%</span>
        </div>

        <!-- Maturity scale -->
        <div class="mt-4">
          <p class="text-sm text-center text-gray-600 mb-2">Ihr KI-Reifegrad</p>
          <div class="scale-container">
            <div class="scale-segment bg-red-500">Awareness</div>
            <div class="scale-segment bg-orange-500">Active</div>
            <div class="scale-segment bg-green-500">Operational</div>
            <div class="scale-segment bg-blue-500">Systemic</div>
            <div class="scale-segment bg-purple-500">Transformational</div>
            <div id="indicator" class="indicator border-red-500" style="left:0%;"></div>
          </div>
          <p id="maturity-text" class="text-center mt-2 font-semibold text-gray-800 text-base">Level 1: Awareness</p>
        </div>

        <div class="mt-8">
          <h3 class="text-xl font-semibold text-gray-900 text-center mb-4">Reifegrad pro Dimension</h3>
          <canvas id="radar" height="320"></canvas>
        </div>

        <div class="mt-6 flex justify-center">
          <button id="download-btn" disabled class="px-6 py-3 btn-brand font-bold rounded-full shadow transition disabled:opacity-50 disabled:cursor-not-allowed">Auswertung herunterladen</button>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-8 leading-relaxed">Die Analyse zeigt Ihnen, wo Sie heute stehen. Im Gespr√§ch erfahren Sie, wie andere Unternehmen ihren Weg weitergegangen sind ‚Äì und welche Optionen es f√ºr Sie gibt. Bei Interesse: <a class="text-red-600 font-medium" href="mailto:meyer@v-und-s.de">meyer@v-und-s.de</a></p>
    </div>
  </div>

  <!-- Message Box for Alerts -->
  <div id="message-box" class="message-box">
    <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-4">
      <h3 id="message-title" class="text-lg font-bold mb-2 text-gray-800"></h3>
      <p id="message-body" class="text-sm text-gray-600 mb-4"></p>
      <div class="flex justify-end">
        <button onclick="hideMessage()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">OK</button>
      </div>
    </div>
  </div>

<script>
// ---------- Global Variables ----------

// Global debug mode flag
let DEBUG_MODE = false;

// ---------- Debug Mode Functions ----------

// Fetch debug mode from backend
async function loadDebugMode() {
  try {
    const response = await fetch('/api/debug-mode');
    const data = await response.json();
    DEBUG_MODE = data.debug_mode;
    if (DEBUG_MODE) {
      console.warn('üîß DEBUG MODE ENABLED - PDF generation without complete data allowed');
      // Show debug banner
      const banner = document.getElementById('debug-banner');
      if (banner) banner.style.display = 'block';

      // Update button states after debug mode is loaded
      if (window.updateProgress) {
        window.updateProgress();
      }
    }
  } catch (e) {
    console.error('Failed to load debug mode:', e);
  }
}

// Fill missing form data with defaults for testing
function fillDebugDefaults() {
  console.log('DEBUG: Auto-filling missing form data');

  // Fill MCQ dimensions with middle values
  MCQ_DIMENSIONS.forEach(dim => {
    const existing = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
    if (!existing) {
      const midOption = Math.ceil(dim.options.length / 2);
      const radio = document.querySelector(`input[name="mcq-${dim.key}"][value="${midOption}"]`);
      if (radio) {
        radio.checked = true;
        console.log(`DEBUG: Set ${dim.key} to option ${midOption}`);
      }
    }
  });

  // Fill Likert scales with middle value (3)
  LIKERT_GROUPS.forEach(grp => {
    grp.items.forEach((q, idx) => {
      const slider = document.querySelector(`input[name="likert-${grp.key}-${idx}"]`);
      if (slider && slider.dataset.touched !== 'true') {
        slider.value = 3;
        slider.dataset.touched = 'true';
        slider.classList.add('touched');
        console.log(`DEBUG: Set likert-${grp.key}-${idx} to 3`);
      }
    });
  });

  // Fill name if empty
  const nameField = document.getElementById('name');
  if (nameField && !nameField.value) {
    nameField.value = 'Test User (DEBUG)';
  }
}

// ---------- Data ----------

// MCQ (Stufe 1‚Äì5) pro Dimension ‚Äì exakt eine Antwort pro Dimension
const MCQ_DIMENSIONS = [
  // Strategie (1‚Äì4)
  {
    key: "Ambition",
    group: "Strategie",
    subtitle: "Zielbild und Rolle von KI im Service",
    options: [
      "Unsere Service-Abteilung ist sich der Relevanz von KI unsicher und wei√ü nicht, welche Rolle KI im Service spielen soll.",
      "Unsere Service-Abteilung ist sich der Relevanz von KI bewusst, ist aber unsicher, welche Rolle KI im Service spielen soll.",
      "Unsere Service-Abteilung versteht die Auswirkungen von KI und hat ein Zielbild entwickelt, an dem wir unsere KI-Aktivit√§ten ausrichten wollen.",
      "Es gibt ein klares Verst√§ndnis daf√ºr, wie unsere Service-Abteilung sich an KI-getriebene Ver√§nderungen anpassen kann. Eine Roadmap ber√ºcksichtigt ethische und rechtliche Aspekte.",
      "KI und ihr Potenzial werden bereits im Tagesgesch√§ft ber√ºcksichtigt (z. B. Wartung, Ersatzteilmanagement, Kundenkommunikation)."
    ]
  },
  {
    key: "Strategie",
    group: "Strategie",
    subtitle: "Abgestimmte KI-Strategie und KPIs",
    options: [
      "Entscheidungen zum Einsatz von KI im Service werden ad hoc getroffen und folgen keinem systematischen Ansatz.",
      "Unsere Service-Abteilung verf√ºgt √ºber eine abgestimmte KI-Strategie mit konkreten Initiativen.",
      "Die KI-Strategie pr√§gt Serviceprozesse und digitale Dienstleistungen; Erfolgsmessung √ºber definierte KPIs.",
      "KI steht im Zentrum unseres Service-Modells (z. B. Predictive Maintenance, digitale Portale)."
    ]
  },
  {
    key: "Use Cases",
    group: "Strategie",
    subtitle: "Systematische Identifikation und Umsetzung von Use Cases",
    options: [
      "Wir haben bisher keine KI-Use-Cases identifiziert/umgesetzt.",
      "Use-Cases entstehen opportunistisch, ohne feste Kriterien.",
      "Wir haben einen Standardprozess: systematisches Finden, Bewerten und Priorisieren.",
      "KI Use Cases werden bereits ganzheitlich entlang der Service-Wertsch√∂pfungskette umgesetzt."
    ]
  },
  {
    key: "Umsetzung",
    group: "Strategie",
    subtitle: "Wertrealisierung & Business-Case",
    options: [
      "Kein Business-Case; Nutzen wird nicht gemessen.",
      "Erste Annahmen/Sch√§tzungen zu Nutzen/ROI vorhanden.",
      "Standardisierte Business-Cases; Benefits werden gemessen und berichtet.",
      "Kontinuierliches Benefits-Tracking steuert Priorisierung/Roadmap."
    ]
  },
  // Organisation (5‚Äì8)
  {
    key: "Organisation",
    group: "Organisation",
    subtitle: "Strukturen, Verantwortlichkeiten und Zusammenarbeit",
    options: [
      "Es gibt keine Verantworlichkeiten oder Strukturen f√ºr KI im Service.",
      "Einzelpersonen treiben Themen in Silos voran.",
      "Klare Verantwortlichkeiten; zentrales Enablement-Team unterst√ºtzt.",
      "IT, Service & Data arbeiten eingespielt; Standards/Best Practices verankert."
    ]
  },
  {
    key: "Expertise",
    group: "Organisation",
    subtitle: "F√§higkeiten und Rollen im Service",
    options: [
      "Uns fehlen die notwendigen F√§higkeiten und Personen, um KI-Projekte umzusetzen.",
      "Das n√∂tige Fachwissen ist in unserer IT Abteilung verankert und wird f√ºr KI-Projekte rangezogen.",
      "Das n√∂tige Fachwissen und relevante Kernrollen sind im Service-Team vorhanden (z. B. KI-Manager, KI-Spezialist, Data Analysts, Service Engineers).",
      "Wir gelten als Vorreiter f√ºr KI im Service; Mitarbeitende arbeiten mit modernster Technologie und pr√§sentieren Ergebnisse extern."
    ]
  },
  {
    key: "Kultur",
    group: "Organisation",
    subtitle: "Mindset, Datenorientierung und Vertrauen",
    options: [
      "Wir haben noch nicht dar√ºber nachgedacht, welches Umfeld f√ºr erfolgreiche KI-Projekte im Service erforderlich ist.",
      "Wir verstehen die Bedeutung von KI-Experimenten und interdisziplin√§rer Zusammenarbeit (Service, IT, Konstruktion).",
      "Wir sehen uns als datengetrieben; F√ºhrungskr√§fte gehen voran und begleiten die Einf√ºhrung aktiv.",
      "Das Vertrauen in KI ist verbreitet; Mitarbeitende verstehen probabilistische Systeme und k√∂nnen damit arbeiten."
    ]
  },
  {
    key: "Adoption",
    group: "Organisation",
    subtitle: "Change- & Adoption-Ansatz",
    options: [
      "Keine strukturierte Adoption vorgesehen.",
      "Schulungen finden anlassbezogen statt.",
      "Rollenbasierte Enablement-Journeys; Champions; Human-in-the-Loop.",
      "Messbare Adoption (Nutzung/Qualit√§t); Feedback flie√üt in Backlog."
    ]
  },
  // Regulatorik (9‚Äì10)
  {
    key: "Governance",
    group: "Regulatorik",
    subtitle: "Verantwortlichkeiten & Governance",
    options: [
      "Es gibt keine klaren Verantwortlichkeiten f√ºr regulatorische KI-Anforderungen.",
      "Verantwortlichkeiten f√ºr regulatorische KI-Themen sind einzelnen Personen nebenbei zugeordnet.",
      "Ein dediziertes Team oder KI-Beauftragte koordinieren regulatorische Anforderungen; Prozesse existieren, sind aber noch punktuell.",
      "Ein institutionalisiertes KI-Compliance-Team steuert Governance, Reviews und Reporting mit klar definierten Entscheidungswegen."
    ]
  },
  {
    key: "Dokumentation",
    group: "Regulatorik",
    subtitle: "Dokumentation & Nachvollziehbarkeit",
    options: [
      "KI-Entscheidungen werden nicht systematisch dokumentiert.",
      "Dokumentation erfolgt fallweise, ohne Standardisierung.",
      "Standardisierte Templates/Prozesse zur Dokumentation (z. B. Modellbeschreibungen, Verantwortliche) sind etabliert.",
      "Dokumentation ist automatisiert, auditierbar und umfasst Modellkarten, Risiko-Logs und freigegebene Leitlinien."
    ]
  },
  // Technologie (11‚Äì12)
  {
    key: "Technologie",
    group: "Technologie",
    subtitle: "Tools, Infrastruktur und Skalierbarkeit",
    options: [
      "Unklar, ob geeignete Tools/Infrastruktur verf√ºgbar sind.",
      "Service-Teams haben Zugang zu erforderlichen Tools/Infrastruktur.",
      "Standardisierung/Zentralisierung mit klaren Leitplanken (Modelle/Plattformen).",
      "Reibungslose Bereitstellung & Skalierung; Integration in Workflows."
    ]
  },
  {
    key: "Daten",
    group: "Technologie",
    subtitle: "Verf√ºgbarkeit, Qualit√§t und Governance",
    options: [
      "F√ºr KI-Projekte im Service fehlen h√§ufig die n√∂tigen Daten oder sie sind von geringer Qualit√§t.",
      "Relevante Datenquellen werden identifiziert; Daten-Pipelines sind etabliert.",
      "Erste Prozesse f√ºr Datenqualit√§t, Datenklassifizierungen, Zust√§ndigkeiten und Zug√§nglichkeit; sowie zentrale Ablagen sind vorhanden.",
      "Zentrales Datensystem erm√∂glicht Suche/Zugang; Mechanismen zur Wahrung der Datenqualit√§t sind etabliert. Daten sind kategorisiert und versioniert."
    ]
  }
];

// Likert (1‚Äì5) ‚Äì Ja/Nein 5-stufig
const LIKERT_GROUPS = [
  {
    key: "Aktuelle Operationalisierung",
    items: [
      "Setzen Sie KI ein, um Kaufverhalten und Pr√§ferenzen Ihrer Kunden vorherzusagen?",
      "Gibt es KI-gest√ºtzte Systeme, die Servicekapazit√§ten unterst√ºtzen (z. B. KI-Assistenten, Chatbots)?",
      "Unterst√ºtzt KI die Priorisierung &/oder Sortierung von Servicef√§llen (z. B. Ticket-Klassifizierung)?",
      "Unterst√ºtzt KI die Einsatzplanung durch automatische Tourenoptimierung und Kapazit√§tsprognosen?",
      "Werden Skills und Verf√ºgbarkeiten von Servicemitarbeitenden durch KI gematcht und dynamisch angepasst?",
      "Nutzt Ihr Unternehmen KI, um \"K√∂nner\"-Wissen verf√ºgbar zu machen?",
      "Nutzen Sie KI f√ºr Anfragen- und Angebotsautomatisierung?",
      "Unterst√ºtzt KI bei kreativen T√§tigkeiten (z. B. Content-Generierung)?",
      "Nutzt Ihr Unternehmen KI, um digitale Serviceprodukte (z. B. KI-gest√ºtzte Wartungsservices) zu entwickeln?"
    ]
  },
  {
    key: "Regulatorik",
    items: [
      "F√ºhlt sich Ihr Unternehmen gut auf zuk√ºnftige gesetzliche Anforderungen (z. B. EU AI Act) vorbereitet?",
      "Haben Sie klare Richtlinien oder Leitlinien f√ºr den Einsatz von KI?",
      "Bewertet Ihr Unternehmen systematisch Risiken von KI-Anwendungen (z. B. Bias, Fehlentscheidungen, Sicherheit)?"
    ]
  },
  {
    key: "Rahmenbedingungen",
    items: [
      "Beinhaltet Ihre Service-/Unternehmensstrategie klare Ziele zur Nutzung von KI?",
      "Ist Ihr Unternehmen generell schnell darin, neue Technologien und digitale Innovationen zu √ºbernehmen?",
      "Beobachten Sie aktiv Markttrends und die Konkurrenz in Bezug auf KI-Einsatz?",
      "Verf√ºgen Ihre Mitarbeiter √ºber die n√∂tigen F√§higkeiten, um KI-Technologien einzuf√ºhren und zu nutzen?",
      "Bieten Sie Schulungen an, um Kompetenzen im Bereich KI/Datenanalyse aufzubauen?",
      "Ist Ihre IT-Infrastruktur (z. B. Rechenleistung, Cloud-Anbindung) f√ºr den Einsatz von KI ausgelegt?",
      "Haben Sie eine Strategie zur Datenverwaltung, die auch die Nutzung f√ºr KI ber√ºcksichtigt?",
      "Gibt es eine ausgepr√§gte Innovationskultur, die Experimente mit KI f√∂rdert?",
      "Verfolgen Sie aktiv Entwicklungen bei Partnern und √ñkosystemen, um neue KI-Chancen zu erkennen?"
    ]
  }
];

const GROUP_DISPLAY_ORDER = [
  { key: "Strategie", label: "Strategie" },
  { key: "Organisation", label: "Organisation" },
  { key: "Regulatorik", label: "Regulatorik" },
  { key: "Technologie", label: "Technologie" },
  { key: "Aktuelle Operationalisierung", label: "Aktuelle Operationalisierung" },
  { key: "Rahmenbedingungen", label: "Rahmenbedingungen" }
];

// Recommendations from original index.html
const recommendations = {
  "Strategie": {
    "Awareness": "Definieren Sie klare KI-Ziele und integrieren Sie diese in die Unternehmensstrategie. Beginnen Sie mit der Erforschung der Wettbewerbslandschaft.",
    "Active": "Etablieren Sie ein dediziertes Budget und ein Team, um erste KI-Projekte zu starten.",
    "Operational": "F√ºhren Sie KI zur Optimierung bestehender Gesch√§ftsprozesse und zur Effizienzsteigerung ein.",
    "Systemic": "Integrieren Sie KI als zentralen Wettbewerbsfaktor in Ihr Gesch√§ftsmodell.",
    "Transformational": "Etablieren Sie eine KI-gest√ºtzte Kultur, die Innovationen im gesamten Unternehmen vorantreibt."
  },
  "Organisation": {
    "Awareness": "Beginnen Sie mit der Identifizierung von Mitarbeitern mit KI-Interesse und schaffen Sie Bewusstsein.",
    "Active": "Bauen Sie erste abteilungs√ºbergreifende Teams auf und definieren Sie klare Verantwortlichkeiten.",
    "Operational": "F√ºhren Sie regelm√§√üige Schulungen durch und schaffen Sie Experimentierr√§ume.",
    "Systemic": "Etablieren Sie eine zentrale KI-Kompetenzstelle mit klaren Rollen und Strukturen.",
    "Transformational": "Schaffen Sie eine agile, lernende Organisation f√ºr schnelle KI-Implementation."
  },
  "Technologie": {
    "Awareness": "F√ºhren Sie eine Bestandsaufnahme Ihrer IT-Infrastruktur und Datenquellen durch.",
    "Active": "Starten Sie mit der Datenerfassung und Aufbereitung kleiner, relevanter Datens√§tze.",
    "Operational": "Implementieren Sie erste Cloud-Dienste und KI-Plattformen zur Prozessautomatisierung.",
    "Systemic": "Etablieren Sie eine robuste Datenstrategie mit zentraler Datenplattform.",
    "Transformational": "Setzen Sie auf skalierbare, voll integrierte KI-Infrastrukturen mit MLOps."
  },
  "Regulatorik": {
    "Awareness": "Beginnen Sie mit der Sensibilisierung f√ºr Datenschutz und Sicherheitsrichtlinien.",
    "Active": "F√ºhren Sie erste interne Richtlinien f√ºr verantwortungsvollen KI-Einsatz ein.",
    "Operational": "Etablieren Sie Prozesse zur systematischen Dokumentation der KI-Nutzung.",
    "Systemic": "Ernennen Sie einen KI-Ethik-Beauftragten und bereiten Sie sich auf den EU AI Act vor.",
    "Transformational": "Verankern Sie Ethik und Compliance fest in allen KI-Prozessen."
  },
  "Aktuelle Operationalisierung": {
    "Awareness": "Identifizieren Sie erste Use Cases f√ºr KI in Ihren Serviceprozessen.",
    "Active": "Starten Sie Pilotprojekte f√ºr KI-gest√ºtzte Serviceoptimierung.",
    "Operational": "Implementieren Sie KI-Tools f√ºr Kundenservice und Prozessautomatisierung.",
    "Systemic": "Integrieren Sie KI durchg√§ngig in Ihre Service-Wertsch√∂pfungskette.",
    "Transformational": "Entwickeln Sie KI-basierte digitale Serviceprodukte und Gesch√§ftsmodelle."
  },
  "Rahmenbedingungen": {
    "Awareness": "Schaffen Sie Bewusstsein f√ºr die Bedeutung von KI in Ihrer Organisation.",
    "Active": "Entwickeln Sie eine KI-Roadmap und beginnen Sie mit ersten Schulungen.",
    "Operational": "Etablieren Sie eine Innovationskultur und systematische Weiterbildung.",
    "Systemic": "Verankern Sie KI-Kompetenz als Kernf√§higkeit in der Organisation.",
    "Transformational": "Werden Sie zum KI-Vorreiter in Ihrer Branche mit eigenen Innovationen."
  }
};

// Maturity levels
const maturityLevels = [
  { level: 1, name: "Awareness", min: 0, max: 20, color: "border-red-500" },
  { level: 2, name: "Active", min: 21, max: 40, color: "border-orange-500" },
  { level: 3, name: "Operational", min: 41, max: 60, color: "border-green-500" },
  { level: 4, name: "Systemic", min: 61, max: 80, color: "border-blue-500" },
  { level: 5, name: "Transformational", min: 81, max: 100, color: "border-purple-500" },
];

// ---------- Rendering ----------

function renderMcq() {
  const container = document.getElementById('mcq-section');
  container.innerHTML = "";

  // Group MCQ dimensions by their 'group' property
  const order = ["Strategie", "Organisation", "Regulatorik", "Technologie"];
  const grouped = new Map();
  MCQ_DIMENSIONS.forEach(d => {
    const g = d.group || 'Sonstiges';
    if (!grouped.has(g)) grouped.set(g, []);
    grouped.get(g).push(d);
  });

  // Ensure original order within groups
  let runningNumber = 1;
  order.forEach(groupName => {
    const dims = grouped.get(groupName);
    if (!dims || !dims.length) return;

    const card = document.createElement('div');
    card.className = "card";

    const title = document.createElement('h3');
    title.className = "text-lg font-semibold text-gray-800 mb-6 accordion-title";
    title.setAttribute('aria-expanded', 'true');
    title.innerHTML = `<span>Dimension: ${groupName}</span><span class="chev text-gray-400">‚Ä∫</span>`;
    card.appendChild(title);

    const content = document.createElement('div');
    content.className = 'accordion-content';

    dims.forEach(dim => {
      const subTitle = document.createElement('h4');
      subTitle.className = "font-medium text-gray-700 mt-6 mb-4";
      subTitle.textContent = `${runningNumber}. ${dim.subtitle || dim.key}`;
      content.appendChild(subTitle);

      const group = document.createElement('div');
      group.className = "pill-group mb-8";

      dim.options.forEach((text, i) => {
        const id = `mcq-${dim.key}-${i+1}`;
        const label = document.createElement('label');
        label.className = "pill";

        const input = document.createElement('input');
        input.type = "radio";
        input.name = `mcq-${dim.key}`;
        input.value = (i+1).toString(); // 1..n
        input.id = id;

        const span = document.createElement('span');
        span.textContent = text;

        label.appendChild(input);
        label.appendChild(span);
        group.appendChild(label);
      });

      content.appendChild(group);
      runningNumber++;
    });

    if (groupName === 'Regulatorik') {
      const regLikert = LIKERT_GROUPS.find(g => g.key === 'Regulatorik');
      if (regLikert) {
        // Create grid container for regulatorik questions
        const gridContainer = document.createElement('div');
        gridContainer.className = 'likert-grid';

        regLikert.items.forEach((q, idx) => {
          const questionBox = document.createElement('div');
          questionBox.className = 'likert-question-box';

          const questionText = document.createElement('div');
          questionText.className = 'likert-question-text';
          questionText.textContent = q;
          questionBox.appendChild(questionText);

          const sliderContainer = document.createElement('div');
          sliderContainer.className = 'likert-slider-container';

          const leftLabel = document.createElement('span');
          leftLabel.className = 'likert-label';
          leftLabel.textContent = 'Nein';
          sliderContainer.appendChild(leftLabel);

          const slider = document.createElement('input');
          slider.type = 'range';
          slider.min = '1';
          slider.max = '5';
          slider.step = '1';
          slider.value = '1';
          slider.name = `likert-${regLikert.key}-${idx}`;
          slider.className = 'likert-slider';
          slider.dataset.touched = 'false';
          sliderContainer.appendChild(slider);

          const rightLabel = document.createElement('span');
          rightLabel.className = 'likert-label';
          rightLabel.textContent = 'Ja';
          sliderContainer.appendChild(rightLabel);

          questionBox.appendChild(sliderContainer);

          const valueDisplay = document.createElement('div');
          valueDisplay.className = 'likert-value';
          const labels = ["Nein", "eher nein", "teilweise", "eher ja", "Ja"];
          const updateValue = () => {
            if (slider.dataset.touched === 'false') {
              valueDisplay.textContent = 'Nicht beantwortet';
              valueDisplay.style.color = '#9ca3af';
            } else {
              const v = parseInt(slider.value, 10);
              valueDisplay.textContent = `${v} ‚Äì ${labels[v-1]}`;
              valueDisplay.style.color = '#374151';
            }
          };

          const activateSlider = () => {
            if (slider.dataset.touched === 'false') {
              slider.dataset.touched = 'true';
              slider.classList.add('touched');
              updateProgress();
            }
            updateValue();
          };

          slider.addEventListener('input', activateSlider);
          slider.addEventListener('click', activateSlider);

          updateValue();
          questionBox.appendChild(valueDisplay);

          gridContainer.appendChild(questionBox);
        });

        content.appendChild(gridContainer);
        runningNumber++;
      }
    }

    card.appendChild(content);
    title.addEventListener('click', () => {
      const expanded = title.getAttribute('aria-expanded') === 'true';
      title.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      content.style.display = expanded ? 'none' : '';
    });

    container.appendChild(card);
  });
}

function renderLikert() {
  const container = document.getElementById('likert-section');
  container.innerHTML = "";

  const filteredGroups = LIKERT_GROUPS.filter(grp => grp.key !== 'Regulatorik');

  filteredGroups.forEach((grp, gidx) => {
    const wrapper = document.createElement('div');
    wrapper.className = "card";

    const title = document.createElement('h3');
    title.className = "text-lg font-semibold text-gray-800 mb-6 accordion-title";
    title.setAttribute('aria-expanded', 'true');
    title.innerHTML = `<span>${MCQ_DIMENSIONS.length + gidx + 1}. ${grp.key}</span><span class="chev text-gray-400">‚Ä∫</span>`;
    wrapper.appendChild(title);

    const content = document.createElement('div');
    content.className = 'accordion-content';

    // Create grid container
    const gridContainer = document.createElement('div');
    gridContainer.className = 'likert-grid';

    grp.items.forEach((q, qidx) => {
      const questionBox = document.createElement('div');
      questionBox.className = 'likert-question-box';

      const questionText = document.createElement('div');
      questionText.className = 'likert-question-text';
      questionText.textContent = q;
      questionBox.appendChild(questionText);

      const sliderContainer = document.createElement('div');
      sliderContainer.className = 'likert-slider-container';

      const leftLabel = document.createElement('span');
      leftLabel.className = 'likert-label';
      leftLabel.textContent = 'Nein';
      sliderContainer.appendChild(leftLabel);

      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = '1';
      slider.max = '5';
      slider.step = '1';
      slider.value = '1';
      slider.name = `likert-${grp.key}-${qidx}`;
      slider.className = 'likert-slider';
      slider.dataset.touched = 'false';
      sliderContainer.appendChild(slider);

      const rightLabel = document.createElement('span');
      rightLabel.className = 'likert-label';
      rightLabel.textContent = 'Ja';
      sliderContainer.appendChild(rightLabel);

      questionBox.appendChild(sliderContainer);

      const valueDisplay = document.createElement('div');
      valueDisplay.className = 'likert-value';
      const labels = ["Nein", "eher nein", "teilweise", "eher ja", "Ja"];
      const updateValue = () => {
        if (slider.dataset.touched === 'false') {
          valueDisplay.textContent = 'Nicht beantwortet';
          valueDisplay.style.color = '#9ca3af';
        } else {
          const v = parseInt(slider.value, 10);
          valueDisplay.textContent = `${v} ‚Äì ${labels[v-1]}`;
          valueDisplay.style.color = '#374151';
        }
      };

      const activateSlider = () => {
        if (slider.dataset.touched === 'false') {
          slider.dataset.touched = 'true';
          slider.classList.add('touched');
          updateProgress();
        }
        updateValue();
      };

      slider.addEventListener('input', activateSlider);
      slider.addEventListener('click', activateSlider);

      updateValue();
      questionBox.appendChild(valueDisplay);

      gridContainer.appendChild(questionBox);
    });

    content.appendChild(gridContainer);
    wrapper.appendChild(content);

    // Toggle
    title.addEventListener('click', () => {
      const expanded = title.getAttribute('aria-expanded') === 'true';
      title.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      content.style.display = expanded ? 'none' : '';
    });

    container.appendChild(wrapper);
  });
}

// ---------- Scoring ----------

function normalize(value, min, max) {
  if (value == null) return 0;
  return (value - min) / (max - min) * 100;
}

function gartnerFromPercent(p) {
  // 5-level mapping 0‚Äì100
  if (p <= 20) return {level:1, name:'Awareness', color:'border-red-500'};
  if (p <= 40) return {level:2, name:'Active', color:'border-orange-500'};
  if (p <= 60) return {level:3, name:'Operational', color:'border-green-500'};
  if (p <= 80) return {level:4, name:'Systemic', color:'border-blue-500'};
  return {level:5, name:'Transformational', color:'border-purple-500'};
}

function calculate() {
  const firmaVal = (document.getElementById('firma')?.value || '').trim();

  // In debug mode, use default firma if not provided
  if (DEBUG_MODE && !firmaVal) {
    document.getElementById('firma').value = 'TEST COMPANY (DEBUG)';
  } else if (!firmaVal) {
    showMessage('Fehler', 'Bitte geben Sie den Firmennamen an.');
    document.getElementById('firma')?.focus();
    return;
  }

  // In debug mode, fill missing data with defaults
  if (DEBUG_MODE) {
    fillDebugDefaults();
  }

  const dimPercents = {};
  const groupBuckets = new Map();
  let allAnswered = true;

  MCQ_DIMENSIONS.forEach(dim => {
    const selected = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
    if (!selected) { allAnswered = false; }
    const points = selected ? parseInt(selected.value, 10) : null; // 1..n
    const percent = points ? normalize(points, 1, dim.options.length) : 0; // 0..100
    dimPercents[dim.key] = percent;
    const bucketName = dim.group || dim.key;
    if (!groupBuckets.has(bucketName)) groupBuckets.set(bucketName, []);
    groupBuckets.get(bucketName).push(percent);
  });

  LIKERT_GROUPS.forEach(grp => {
    let sum = 0, cnt = 0;
    grp.items.forEach((q, idx) => {
      const sel = document.querySelector(`input[name="likert-${grp.key}-${idx}"]`);
      if (sel && sel.dataset.touched === 'true') {
        const val = parseInt(sel.value, 10); // 1..5
        if (val != null && !Number.isNaN(val)) { sum += val; cnt++; }
      } else {
        allAnswered = false;
      }
    });
    const avg = cnt ? (sum / cnt) : 0;
    const percent = cnt ? normalize(avg, 1, 5) : 0;
    dimPercents[grp.key] = percent;
    groupBuckets.set(grp.key, [percent]);
  });

  if (!allAnswered && !DEBUG_MODE) {
    showMessage('Fehler', 'Bitte beantworten Sie alle Fragen.');
    return;
  }

  const aggregatedPercents = {};
  groupBuckets.forEach((vals, name) => {
    const valid = vals.filter(v => !Number.isNaN(v));
    const avg = valid.length ? valid.reduce((a,b) => a + b, 0) / valid.length : 0;
    aggregatedPercents[name] = avg;
  });
  const aggregatedEntries = GROUP_DISPLAY_ORDER
    .map(({ key, label }) => ({ key, label, value: aggregatedPercents[key] }))
    .filter(entry => entry.value != null);

  const grid = document.getElementById('scores-grid');
  grid.innerHTML = "";
  const gaugeColor = (score) => {
    if (score <= 20) return '#ef4444';
    if (score <= 40) return '#f97316';
    if (score <= 60) return '#22c55e';
    if (score <= 80) return '#3b82f6';
    return '#7c3aed';
  };

  aggregatedEntries.forEach(({ label, value }) => {
    const card = document.createElement('div');
    card.className = "bg-white rounded-lg p-4 shadow-sm";

    const title = document.createElement('p');
    title.className = "font-medium text-gray-800 mb-2";
    title.textContent = label;
    card.appendChild(title);

    const barWrap = document.createElement('div');
    barWrap.className = "gauge-bar-container";
    const bar = document.createElement('div');
    bar.className = "gauge-bar";
    bar.style.width = value.toFixed(1) + '%';
    bar.style.backgroundColor = gaugeColor(value);
    barWrap.appendChild(bar);
    card.appendChild(barWrap);

    const val = document.createElement('p');
    val.className = "text-xl font-bold text-gray-900 mt-2";
    val.textContent = value.toFixed(1) + '%';
    card.appendChild(val);

    grid.appendChild(card);
  });

  const values = aggregatedEntries.map(entry => entry.value);
  const overall = values.length ? values.reduce((a,b) => a + b, 0) / values.length : 0;
  document.getElementById('total-score').textContent = overall.toFixed(1) + '%';

  const ind = document.getElementById('indicator');
  const maturityText = document.getElementById('maturity-text');
  ind.style.left = Math.max(0, Math.min(100, overall)) + '%';
  const g = gartnerFromPercent(overall);
  ind.className = 'indicator ' + g.color;
  maturityText.textContent = `Level ${g.level}: ${g.name}`;

  const ctx = document.getElementById('radar').getContext('2d');
  if (window._radar) { window._radar.destroy(); }
  const brandHex = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#6366f1';
  const hexToRgb = (hex) => {
    const h = hex.replace('#','');
    const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h, 16);
    const r = (bigint >> 16) & 255; const g = (bigint >> 8) & 255; const b = bigint & 255; return {r,g,b};
  };
  const rgb = hexToRgb(brandHex);
  const radarLabels = aggregatedEntries.map(entry => entry.label);
  const radarValues = aggregatedEntries.map(entry => entry.value);
  window._radar = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: radarLabels,
      datasets: [{
        label: 'Reifegrad (%)',
        data: radarValues,
        fill: true,
        backgroundColor: `rgba(${rgb.r},${rgb.g},${rgb.b},0.15)`,
        borderColor: `rgba(${rgb.r},${rgb.g},${rgb.b},1)`,
        pointBackgroundColor: `rgba(${rgb.r},${rgb.g},${rgb.b},1)`
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } }
      },
      plugins: { legend: { display: false } }
    }
  });

  document.getElementById('results').classList.remove('hidden');
  const dl = document.getElementById('download-btn');
  if (dl) dl.disabled = false;
  const hint = document.getElementById('calc-hint');
  if (hint) { hint.classList.add('hidden'); hint.textContent = ''; }

  // Send to backend (from original index.html)
  sendToBackend(aggregatedPercents, overall, g);
}

// ---------- Backend Integration (from original index.html) ----------

async function sendToBackend(categoryScores, totalScore, maturityInfo) {
  console.log('===== SENDING DATA TO BACKEND =====');
  console.log('Total Score:', totalScore);
  console.log('Category Scores:', categoryScores);
  console.log('Maturity Level:', maturityInfo.name);

  // Get insights
  const insights = {};
  for (const [category, score] of Object.entries(categoryScores)) {
    const level = maturityLevels.find(l => score >= l.min && score <= l.max);
    if (level && recommendations[category] && recommendations[category][level.name]) {
      insights[category] = recommendations[category][level.name];
    }
  }

  // Collect user answers
  const userAnswers = {};
  MCQ_DIMENSIONS.forEach(dim => {
    const selected = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
    if (selected) {
      userAnswers[`mcq-${dim.key}`] = parseInt(selected.value, 10);
    }
  });

  LIKERT_GROUPS.forEach(grp => {
    grp.items.forEach((q, idx) => {
      const sel = document.querySelector(`input[name="likert-${grp.key}-${idx}"]`);
      if (sel && sel.dataset.touched === 'true') {
        userAnswers[`likert-${grp.key}-${idx}`] = parseInt(sel.value, 10);
      }
    });
  });

  // Get contact info
  const nameInput = document.getElementById('name');
  const firmaInput = document.getElementById('firma');

  const contactInfo = {
    name: nameInput?.value || '',
    company: firmaInput?.value || ''
  };

  const data = {
    scores: categoryScores,
    totalScore: totalScore,
    maturityLevel: maturityInfo.name,
    insights: insights,
    contactInfo: contactInfo,
    userAnswers: userAnswers
  };

  console.log('Full data payload:', JSON.stringify(data, null, 2));

  try {
    console.log('Sending POST request to /api/submit-assessment');
    const response = await fetch('/api/submit-assessment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });

    console.log('Response status:', response.status);
    console.log('Response ok:', response.ok);

    if (response.ok) {
      const result = await response.json();
      console.log('‚úÖ Assessment sent successfully:', result);
      // showMessage('Erfolg', 'Die Ergebnisse wurden erfolgreich per E-Mail versendet!');
    } else {
      const errorText = await response.text();
      console.error('‚ùå Failed to send assessment. Status:', response.status);
      console.error('Error response:', errorText);
      showMessage('Fehler', `Die Ergebnisse konnten nicht versendet werden. Status: ${response.status}`);
    }
  } catch (error) {
    console.error('‚ùå Error sending assessment:', error);
    console.error('Error details:', error.message);
    showMessage('Fehler', 'Verbindung zum Server fehlgeschlagen. Die Ergebnisse konnten nicht versendet werden.');
  }
  console.log('===== END SENDING DATA =====');
}

// ---------- Data Collection / Export ----------

function collectData(requireAll=true) {
  // Override requireAll if in debug mode
  if (DEBUG_MODE && requireAll) {
    console.log('DEBUG_MODE: Bypassing data validation');
    requireAll = false;
  }

  const name = (document.getElementById('name')?.value || '').trim();
  const firma = (document.getElementById('firma')?.value || '').trim();
  let allAnswered = true;

  const mcqAnswers = [];
  const dimPercents = {};
  const groupBuckets = new Map();

  MCQ_DIMENSIONS.forEach(dim => {
    const selected = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
    if (!selected) { allAnswered = false; }
    const points = selected ? parseInt(selected.value, 10) : null; // 1..n
    const percent = points ? normalize(points, 1, dim.options.length) : 0; // 0..100
    dimPercents[dim.key] = percent;
    const bucketName = dim.group || dim.key;
    if (!groupBuckets.has(bucketName)) groupBuckets.set(bucketName, []);
    groupBuckets.get(bucketName).push(percent);
    mcqAnswers.push({ dimension: dim.key, value: points, text: points ? dim.options[points-1] : null });
  });

  const likertLabels = ["Nein", "eher nein", "teilweise", "eher ja", "Ja"];
  const likertAnswers = [];

  LIKERT_GROUPS.forEach(grp => {
    let sum = 0, cnt = 0;
    const groupAnswers = [];
    grp.items.forEach((q, idx) => {
      const sel = document.querySelector(`input[name="likert-${grp.key}-${idx}"]`);
      let val = null;
      if (sel && sel.dataset.touched === 'true') {
        val = parseInt(sel.value, 10); // 1..5
        if (val != null && !Number.isNaN(val)) { sum += val; cnt++; }
      } else {
        allAnswered = false;
      }
      groupAnswers.push({ question: q, value: val, label: val ? likertLabels[val-1] : null });
    });
    const avg = cnt ? (sum / cnt) : 0;
    const percent = cnt ? normalize(avg, 1, 5) : 0;
    dimPercents[grp.key] = percent;
    groupBuckets.set(grp.key, [percent]);
    likertAnswers.push({ group: grp.key, answers: groupAnswers });
  });

  if (requireAll && !allAnswered) return null;

  const aggregatedPercents = {};
  groupBuckets.forEach((vals, name) => {
    const valid = vals.filter(v => !Number.isNaN(v));
    const avg = valid.length ? valid.reduce((a,b) => a + b, 0) / valid.length : 0;
    aggregatedPercents[name] = avg;
  });
  const aggregatedEntries = GROUP_DISPLAY_ORDER
    .map(({ key, label }) => ({ key, label, value: aggregatedPercents[key] }))
    .filter(entry => entry.value != null);
  const orderLabels = aggregatedEntries.map(entry => entry.label);
  const orderValues = aggregatedEntries.map(entry => entry.value);
  const overall = orderValues.length ? orderValues.reduce((a,b)=>a+b,0) / orderValues.length : 0;
  const g = gartnerFromPercent(overall);

  return {
    name,
    firma,
    allAnswered,
    orderLabels,
    orderValues,
    dimPercents,
    aggregatedPercents,
    overall,
    gartner: g,
    details: { mcq: mcqAnswers, likert: likertAnswers }
  };
}

// Generate Excel (.xlsx) using SheetJS
function generateExcel(data) {
  const wb = XLSX.utils.book_new();
  const overview = [
    ["Name", data.name || ''],
    ["Firma", data.firma],
    ["Gesamtscore (%)", Number(data.overall.toFixed(1))],
    ["Reifegrad", `Level ${data.gartner.level} ‚Äì ${data.gartner.name}`],
    ["Zeitstempel", new Date().toISOString()]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(overview), "√úbersicht");

  const scoresRows = [["Dimension", "Score (%)"]];
  data.orderLabels.forEach((label, i) => {
    scoresRows.push([label, Number(data.orderValues[i].toFixed(1))]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(scoresRows), "Scores");

  const mcqRows = [["Dimension", "Wert (1‚Äì4)", "Antworttext"]];
  data.details.mcq.forEach(r => mcqRows.push([r.dimension, r.value ?? '', r.text ?? '']));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mcqRows), "MCQ-Antworten");

  const likertRows = [["Gruppe", "Frage", "Wert (1‚Äì5)", "Label"]];
  data.details.likert.forEach(g => {
    g.answers.forEach(a => likertRows.push([g.group, a.question, a.value ?? '', a.label ?? '']));
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(likertRows), "Likert-Antworten");

  const safeName = (data.firma || 'unternehmen').replace(/[^a-z0-9_-]+/gi,'_');
  XLSX.writeFile(wb, `auswertung_${safeName}_${Date.now()}.xlsx`);
}

// Generate Premium PDF
async function generatePdf(data) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    showMessage('Fehler', 'PDF-Bibliothek nicht geladen.');
    return;
  }
  const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

  // Premium spacing and typography settings
  const marginX = 60; // Increased margins for premium look
  const pageWidth = doc.internal.pageSize.getWidth();
  const contentW = pageWidth - marginX * 2;
  const pageH = doc.internal.pageSize.getHeight();
  const bottomY = pageH - 60; // Increased bottom margin

  // Typography scale
  const typography = {
    hero: 26,
    title: 18,
    subtitle: 14,
    body: 12,
    small: 10,
    tiny: 9
  };

  // Spacing system
  const spacing = {
    xl: 50,
    lg: 40,
    md: 30,
    sm: 20,
    xs: 15,
    xxs: 10
  };

  let currentPage = 1;
  const newPageIfNeeded = (y, extra = 0) => {
    if (y + extra > bottomY) {
      doc.addPage();
      currentPage++;
      addPageFooter(currentPage);
      return 80; // Start position on new page
    }
    return y;
  };

  // Color palette
  const brandHex = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#C9133B';
  const hexToRgb = (hex) => {
    const h = hex.replace('#','');
    const bigint = parseInt(h.length === 3 ? h.split('').map(c => c + c).join('') : h, 16);
    return {
      r: (bigint >> 16) & 255,
      g: (bigint >> 8) & 255,
      b: bigint & 255
    };
  };
  const brandRgb = hexToRgb(brandHex);

  // Extended color palette
  const colors = {
    brand: brandRgb,
    dark: { r: 31, g: 41, b: 55 },
    gray: { r: 107, g: 114, b: 128 },
    lightGray: { r: 156, g: 163, b: 175 },
    bgLight: { r: 248, g: 250, b: 252 },
    bgCard: { r: 252, g: 252, b: 253 },
    border: { r: 229, g: 231, b: 235 },
    success: { r: 34, g: 197, b: 94 },
    warning: { r: 249, g: 115, b: 22 },
    danger: { r: 239, g: 68, b: 68 },
    blue: { r: 59, g: 130, b: 246 },
    purple: { r: 124, g: 58, b: 237 }
  };

  // Helper function for score colors - use dark color for clean design
  const getScoreColor = (score) => {
    return colors.dark; // Always use dark gray/black for clean design
  };

  // Add page footer helper
  const addPageFooter = (pageNum) => {
    doc.setFontSize(typography.tiny);
    doc.setTextColor(colors.lightGray.r, colors.lightGray.g, colors.lightGray.b);
    doc.text(`Seite ${pageNum}`, pageWidth / 2, pageH - 30, { align: 'center' });
    doc.setDrawColor(colors.border.r, colors.border.g, colors.border.b);
    doc.setLineWidth(0.5);
    doc.line(marginX, pageH - 45, pageWidth - marginX, pageH - 45);
  };

  // Premium header with gradient effect
  const headerHeight = 120;

  // Main header rectangle
  doc.setFillColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.rect(0, 0, pageWidth, headerHeight, 'F');

  // Add subtle gradient overlay with transparency
  //doc.setFillColor(255, 255, 255);
  //doc.setGState(new doc.GState({ opacity: 0.1 }));
  //doc.rect(0, 0, pageWidth, headerHeight / 2, 'F');
  //doc.setGState(new doc.GState({ opacity: 1 }));

  // Header content
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(typography.hero);
  doc.setTextColor(255, 255, 255);
  doc.text('KI-Reifegrad Analyse', marginX, 45);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(typography.subtitle);
  doc.text('KI & Service-Excellence', marginX, 68);

  // Header info with better layout
  doc.setFontSize(typography.body);

  // Company name with icon-like bullet
  doc.setFont('helvetica', 'bold');
  //doc.text('‚ñ™', marginX, 90);
  doc.setFont('helvetica', 'normal');
  doc.text(data.firma || 'Unternehmen', marginX, 90);

  //if (data.name && data.name !== 'Test User (DEBUG)') {
    //doc.text('‚ñ™', marginX, 105);
    doc.text(data.name, marginX , 105);
  //}

  // Date on the right
  const dateStr = new Date().toLocaleDateString('de-DE', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  doc.text(dateStr, pageWidth - marginX, 90, { align: 'right' });

  // Contact email
  doc.setFontSize(typography.small);
  doc.textWithLink('meyer@v-und-s.de', pageWidth - marginX, 105, {
    url: 'mailto:meyer@v-und-s.de',
    align: 'right'
  });

  // Add decorative line
  // doc.setDrawColor(255, 255, 255);
  // doc.setLineWidth(1);
  // doc.setGState(new doc.GState({ opacity: 0.3 }));
  // doc.line(marginX, headerHeight - 15, pageWidth - marginX, headerHeight - 15);
  // doc.setGState(new doc.GState({ opacity: 1 }));

  let currentY = headerHeight + spacing.lg;

  // Executive Summary Card with premium design
  const summaryHeight = 140; // Increased height for more spacing

  // Card shadow effect
  doc.setFillColor(0, 0, 0);
  doc.setGState(new doc.GState({ opacity: 0.08 }));
  doc.roundedRect(marginX + 3, currentY + 3, contentW, summaryHeight, 15, 15, 'F');
  doc.setGState(new doc.GState({ opacity: 1 }));

  // Card background
  doc.setFillColor(255, 255, 255);
  doc.roundedRect(marginX, currentY, contentW, summaryHeight, 15, 15, 'F');

  // Card border
  doc.setDrawColor(colors.border.r, colors.border.g, colors.border.b);
  doc.setLineWidth(0.5);
  doc.roundedRect(marginX, currentY, contentW, summaryHeight, 15, 15, 'S');

  // Summary content with better layout
  const summaryPadding = 30; // Increased padding

  // Left side - Score visualization
  const gaugeX = marginX + summaryPadding;
  const gaugeY = currentY + summaryPadding;

  // Score label
  doc.setFontSize(typography.small);
  doc.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
  doc.setFont('helvetica', 'normal');
  doc.text('GESAMTERGEBNIS', gaugeX, gaugeY + 15); // More space from top

  // Large score display
  doc.setFontSize(42);
  const scoreColor = getScoreColor(data.overall);
  doc.setTextColor(scoreColor.r, scoreColor.g, scoreColor.b);
  doc.setFont('helvetica', 'bold');
  doc.text(`${data.overall.toFixed(1)}%`, gaugeX, gaugeY + 55); // More space between label and score

  // Visual gauge bar
  const gaugeWidth = 180;
  const gaugeHeight = 10;
  const gaugeYPos = gaugeY + 70; // More space below score

  // Gauge background
  doc.setFillColor(colors.bgLight.r, colors.bgLight.g, colors.bgLight.b);
  doc.roundedRect(gaugeX, gaugeYPos, gaugeWidth, gaugeHeight, 5, 5, 'F');

  // Gauge segments for visual reference
  for (let i = 0; i < 5; i++) {
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(1);
    doc.line(gaugeX + (i * gaugeWidth / 4), gaugeYPos, gaugeX + (i * gaugeWidth / 4), gaugeYPos + gaugeHeight);
  }

  // Gauge fill
  doc.setFillColor(scoreColor.r, scoreColor.g, scoreColor.b);
  const fillWidth = (data.overall / 100) * gaugeWidth;
  doc.roundedRect(gaugeX, gaugeYPos, fillWidth, gaugeHeight, 5, 5, 'F');

  // Right side - Maturity level
  const maturityX = marginX + contentW / 2 + 30;

  doc.setFontSize(typography.small);
  doc.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
  doc.setFont('helvetica', 'normal');
  doc.text('REIFEGRAD-STUFE', maturityX, gaugeY + 15); // Aligned with left side

  // Level badge
  doc.setFillColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.setGState(new doc.GState({ opacity: 0.1 }));
  doc.roundedRect(maturityX - 5, gaugeY + 25, 80, 35, 8, 8, 'F'); // Taller badge for more spacing
  doc.setGState(new doc.GState({ opacity: 1 }));

  doc.setFontSize(typography.title);
  doc.setTextColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.setFont('helvetica', 'bold');
  doc.text(`Level ${data.gartner.level}`, maturityX, gaugeY + 45); // More space

  doc.setFontSize(typography.subtitle);
  doc.setTextColor(colors.dark.r, colors.dark.g, colors.dark.b);
  doc.setFont('helvetica', 'normal');
  doc.text(data.gartner.name, maturityX, gaugeY + 75); // Even more space below badge

  currentY += summaryHeight + spacing.xl;

  // Section title helper with decorative element
  const addSectionTitle = (title, y) => {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(typography.title);
    doc.setTextColor(colors.dark.r, colors.dark.g, colors.dark.b);
    doc.text(title, marginX, y);

    // Decorative accent line
    doc.setDrawColor(brandRgb.r, brandRgb.g, brandRgb.b);
    doc.setLineWidth(3);
    doc.line(marginX, y + 6, marginX + 50, y + 6);

    return y + spacing.md;
  };

  // Dimension scores with premium cards
  currentY = addSectionTitle('Detaillierte Bewertung nach Dimensionen', currentY);

  const cardGap = 20;
  const cardWidth = (contentW - cardGap) / 2;
  const cardHeight = 85;
  const numRows = Math.ceil(data.orderLabels.length / 2);

  for (let row = 0; row < numRows; row++) {
    currentY = newPageIfNeeded(currentY, cardHeight);

    for (let col = 0; col < 2; col++) {
      const idx = row * 2 + col;
      if (idx >= data.orderLabels.length) break;

      const cellX = marginX + col * (cardWidth + cardGap);
      const cellY = currentY;
      const score = data.orderValues[idx];
      const scoreColor = getScoreColor(score);

      // Card shadow
      doc.setFillColor(0, 0, 0);
      doc.setGState(new doc.GState({ opacity: 0.05 }));
      doc.roundedRect(cellX + 2, cellY + 2, cardWidth, cardHeight, 10, 10, 'F');
      doc.setGState(new doc.GState({ opacity: 1 }));

      // Card background
      doc.setFillColor(255, 255, 255);
      doc.roundedRect(cellX, cellY, cardWidth, cardHeight, 10, 10, 'F');

      // Card border
      doc.setDrawColor(colors.border.r, colors.border.g, colors.border.b);
      doc.setLineWidth(0.5);
      doc.roundedRect(cellX, cellY, cardWidth, cardHeight, 10, 10, 'S');

      // Simple accent bar on left (using brand color for visual hierarchy)
      doc.setFillColor(brandRgb.r, brandRgb.g, brandRgb.b);
      doc.roundedRect(cellX, cellY, 4, cardHeight, 10, 0, 'F');

      // Card content
      doc.setFontSize(typography.body);
      doc.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
      doc.setFont('helvetica', 'normal');
      doc.text(data.orderLabels[idx], cellX + 20, cellY + 25);

      // Score with large font
      doc.setFontSize(24);
      doc.setTextColor(scoreColor.r, scoreColor.g, scoreColor.b);
      doc.setFont('helvetica', 'bold');
      doc.text(`${score.toFixed(1)}%`, cellX + 20, cellY + 52);

      // Mini progress bar with brand color
      const barWidth = cardWidth - 40;
      const barHeight = 6;
      const barY = cellY + 62;

      doc.setFillColor(colors.bgLight.r, colors.bgLight.g, colors.bgLight.b);
      doc.roundedRect(cellX + 20, barY, barWidth, barHeight, 3, 3, 'F');

      doc.setFillColor(brandRgb.r, brandRgb.g, brandRgb.b);
      const fillW = (score / 100) * barWidth;
      doc.roundedRect(cellX + 20, barY, fillW, barHeight, 3, 3, 'F');
    }

    currentY += cardHeight + spacing.sm;
  }

  currentY += spacing.md;

  // Radar chart with premium frame
  const canvas = document.getElementById('radar');
  if (canvas) {
    const chartHeight = 380; // Larger for premium look
    currentY = newPageIfNeeded(currentY, chartHeight + 80);

    currentY = addSectionTitle('Kompetenzprofil-Visualisierung', currentY);

    // Chart frame/card
    doc.setFillColor(0, 0, 0);
    doc.setGState(new doc.GState({ opacity: 0.05 }));
    doc.roundedRect(marginX + 2, currentY + 2, contentW, chartHeight + 20, 12, 12, 'F');
    doc.setGState(new doc.GState({ opacity: 1 }));

    doc.setFillColor(255, 255, 255);
    doc.roundedRect(marginX, currentY, contentW, chartHeight + 20, 12, 12, 'F');

    doc.setDrawColor(colors.border.r, colors.border.g, colors.border.b);
    doc.setLineWidth(0.5);
    doc.roundedRect(marginX, currentY, contentW, chartHeight + 20, 12, 12, 'S');

    // Export radar chart at higher quality
    const imgData = canvas.toDataURL('image/png', 1.0);
    const ratio = canvas.height ? (canvas.height / canvas.width) : 1;
    const imgW = Math.min(contentW - 40, chartHeight / ratio);
    const imgH = imgW * ratio;
    const offsetX = marginX + (contentW - imgW) / 2;

    doc.addImage(imgData, 'PNG', offsetX, currentY + 10, imgW, imgH);
    currentY += chartHeight + spacing.xl;
  }

  // Premium disclaimer section
  currentY = newPageIfNeeded(currentY, 150);
  currentY += spacing.md;

  // Disclaimer card
  doc.setFillColor(colors.bgLight.r, colors.bgLight.g, colors.bgLight.b);
  doc.roundedRect(marginX, currentY, contentW, 120, 12, 12, 'F');

  doc.setFontSize(typography.body);
  doc.setTextColor(colors.dark.r, colors.dark.g, colors.dark.b);
  doc.setFont('helvetica', 'bold');
  doc.text('N√§chste Schritte', marginX + 20, currentY + 25);

  doc.setFontSize(typography.small);
  doc.setTextColor(colors.gray.r, colors.gray.g, colors.gray.b);
  doc.setFont('helvetica', 'normal');

  const disclaimerText = "Die Ergebnisse geben Ihnen einen ersten Eindruck Ihres KI-Reifegrads. Eine vollst√§ndige Bewertung umfasst jedoch weitere qualitative Aspekte. Vereinbaren Sie jetzt Ihr unverbindliches und kostenfreies Erstgespr√§ch.";

  const lines = doc.splitTextToSize(disclaimerText, contentW - 40);
  let lineY = currentY + 45;
  lines.forEach((line, i) => {
    doc.text(line, marginX + 20, lineY + (i * 14));
  });

  // Calculate dynamic button position based on text height
  const textEndY = lineY + (lines.length * 14);
  const btnY = textEndY + 20; // Add 20pt spacing after text

  doc.setFillColor(brandRgb.r, brandRgb.g, brandRgb.b);
  doc.roundedRect(marginX + 20, btnY, 140, 25, 5, 5, 'F');

  doc.setFontSize(typography.small);
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.textWithLink('meyer@v-und-s.de', marginX + 90, btnY + 16, {
    url: 'mailto:meyer@v-und-s.de',
    align: 'center'
  });

  // Add page footer to first page
  addPageFooter(1);

  const safeName = (data.firma || 'unternehmen').replace(/[^a-z0-9_-]+/gi, '_');
  doc.save(`ki-reifegrad_${safeName}_${Date.now()}.pdf`);
}

// ---------- Events ----------

document.getElementById('calc-btn').addEventListener('click', calculate);
document.getElementById('reset-btn').addEventListener('click', () => {
  // reset all radios
  document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
  document.getElementById('results').classList.add('hidden');
  // reset likert sliders
  document.querySelectorAll('input[name^="likert-"]').forEach(s => {
    s.value = '1';
    s.dataset.touched = 'false';
    s.classList.remove('touched');
    s.dispatchEvent(new Event('input'));
  });
  // clear firm name
  const firma = document.getElementById('firma');
  if (firma) firma.value = '';
  const name = document.getElementById('name');
  if (name) name.value = '';
  // disable buttons
  const dl = document.getElementById('download-btn');
  if (dl) dl.disabled = true;
  const calc = document.getElementById('calc-btn');
  if (calc) calc.disabled = true;
  // reset progress
  updateProgress();
});

document.getElementById('download-btn')?.addEventListener('click', async () => {
  const firmaVal = (document.getElementById('firma')?.value || '').trim();

  // In debug mode, use default firma if not provided
  if (DEBUG_MODE && !firmaVal) {
    document.getElementById('firma').value = 'TEST COMPANY (DEBUG)';
  } else if (!firmaVal) {
    showMessage('Fehler', 'Bitte geben Sie den Firmennamen an.');
    document.getElementById('firma')?.focus();
    return;
  }

  // In debug mode, fill missing data with defaults
  if (DEBUG_MODE) {
    fillDebugDefaults();
  }

  const data = collectData(!DEBUG_MODE); // Only require all if NOT in debug
  if (!data) {
    showMessage('Fehler', 'Bitte beantworten Sie alle Fragen, bevor Sie die Auswertung herunterladen.');
    return;
  }
  try {
    // Generate both Excel and PDF files
    generateExcel(data);
    await generatePdf(data);
  } catch (e) {
    console.error(e);
    showMessage('Fehler', 'Beim Erstellen der Auswertung ist ein Fehler aufgetreten.');
  }
});

// Message box functions
function showMessage(title, body) {
  const messageBox = document.getElementById('message-box');
  const messageTitle = document.getElementById('message-title');
  const messageBody = document.getElementById('message-body');
  messageTitle.textContent = title;
  messageBody.textContent = body;
  messageBox.classList.add('show');
}

function hideMessage() {
  const messageBox = document.getElementById('message-box');
  messageBox.classList.remove('show');
}

// Bind progress and enable/disable logic
function initUX(){
  function answeredMcqCount(){
    let cnt = 0;
    MCQ_DIMENSIONS.forEach(dim => {
      const sel = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
      if (sel) cnt++;
    });
    return cnt;
  }
  window.updateProgress = function(){
    const totalMcq = MCQ_DIMENSIONS.length;
    const totalLikert = LIKERT_GROUPS.reduce((sum, grp) => sum + grp.items.length, 0);
    const total = totalMcq + totalLikert;

    const answeredMcq = answeredMcqCount();
    const answeredLikert = document.querySelectorAll('input[name^="likert-"].touched').length;
    const answered = answeredMcq + answeredLikert;

    const pct = total ? Math.round(answered/total*100) : 0;
    const bar = document.getElementById('progress-bar');
    const txt = document.getElementById('progress-text');
    if (bar) bar.style.width = pct + '%';
    if (txt) txt.textContent = `${answered}/${total}`;
    const calc = document.getElementById('calc-btn');
    const firma = (document.getElementById('firma')?.value || '').trim();
    const ready = (answered === total && !!firma) || DEBUG_MODE; // Enable in debug mode
    if (calc) calc.disabled = !ready;

    // Build hint message if not ready
    const hint = document.getElementById('calc-hint');
    if (hint) {
      if (ready) {
        hint.classList.add('hidden');
        hint.textContent = '';
      } else if (!DEBUG_MODE) { // Only show hints in production mode
        const missing = [];
        if (!firma) missing.push('Firmenname');
        MCQ_DIMENSIONS.forEach(dim => {
          const sel = document.querySelector(`input[name="mcq-${dim.key}"]:checked`);
          if (!sel) missing.push(dim.subtitle || dim.key);
        });
        hint.textContent = 'Bitte fehlende Angaben erg√§nzen: ' + missing.join(', ');
        hint.classList.remove('hidden');
      } else {
        // In debug mode, show debug message instead
        hint.textContent = 'DEBUG MODE: Auswertung ohne vollst√§ndige Daten m√∂glich';
        hint.classList.remove('hidden');
        hint.style.color = '#d97706'; // Orange color for debug
      }
    }
  };
  // MCQ changes
  document.querySelectorAll('input[type="radio"]').forEach(r => r.addEventListener('change', updateProgress));
  // Firma changes
  const firmaEl = document.getElementById('firma');
  if (firmaEl) firmaEl.addEventListener('input', updateProgress);
  // Init
  updateProgress();
}

// Init
document.addEventListener('DOMContentLoaded', async () => {
  renderMcq();
  renderLikert();
  await loadDebugMode();
  initUX(); // Initialize progress tracking after DOM is ready
});
</script>
</body>
</html>